### 问题三的要求
在任务2设计的诊断模型基础上，充分考虑源域与目标域的**共性特征**（轴承类型一致、特征维度一致、故障物理机制一致）与**差异特征**（转速不同导致的频域分布差异、数据分布偏移），设计基于领域对抗神经网络（DANN）的迁移学习方法，构建目标域诊断模型：通过特征提取器捕捉**域不变特征**（同时适用于源域与目标域的故障判别特征），通过域对抗机制减少**域分布差异**（源域与目标域的特征分布偏移），最终对目标域16个未知标签样本进行分类标定，并可视化迁移效果。

### 问题三的数学模型建立

#### 一、问题三所需的数据文件
1. **源域特征数据集**：`Source_Features.csv`，包含161个源域样本的**13维特征**（时域5维：`Peak`/`RMS`/`CrestFactor`/`ImpulseFactor`/`Kurtosis`；频域3维：`Amp_BPFO`/`Amp_BPFI`/`Amp_BSF`；时频4维：`Energy_WP1`-`Energy_WP4`）及故障标签`Label`（0=正常、1=内圈、2=外圈、3=滚动体）。
2. **目标域数据集**：16个`.mat`文件，每个文件包含**时域振动信号**（`time`/`acceleration`）、**轴承属性**（`bearing_type`/`rpm`），需通过问题一的特征提取方法转化为13维特征。
3. **辅助表格**：`bearing_geometry_params.csv`（轴承几何参数）与`fault_frequency_formula.csv`（故障特征频率公式），用于计算目标域样本的**理论故障频率**（频域特征提取的基础）。

#### 二、问题三的变量定义与物理含义
- **源域特征矩阵**：\( X_s = [\mathbf{x}*{s,1}, \mathbf{x}*{s,2}, ..., \mathbf{x}*{s,161}]^T \in \mathbb{R}^{161 \times 13} \)，其中第\( i \)行\( \mathbf{x}*{s,i} = [\text{Peak}_i, \text{RMS}_i, \text{CrestFactor}_i, \text{ImpulseFactor}_i, \text{Kurtosis}_i, \text{Amp_BPFO}_i, \text{Amp_BPFI}_i, \text{Amp_BSF}_i, \text{Energy_WP1}_i, \text{Energy_WP2}_i, \text{Energy_WP3}_i, \text{Energy_WP4}_i]^T \)为源域样本\( i \)的13维特征向量。
- **源域标签向量**：\( y_s = [y_{s,1}, y_{s,2}, ..., y_{s,161}]^T \in \mathbb{N}^{161 \times 1} \)，\( y_{s,i} \in \{0,1,2,3\} \)为源域样本\( i \)的故障标签。
- **目标域样本集合**：\( \mathcal{T} = \{t_1, t_2, ..., t_{16}\} \)，每个样本\( t_j \)的属性：
  - \( t_j^{\text{acc}} = [a_{j,1}, a_{j,2}, ..., a_{j,N}]^T \in \mathbb{R}^N \)：时域振动加速度信号（\( N \)为采样点数，时长4秒）；
  - \( t_j^{\text{bt}} \in \{\text{SKF6205}, \text{SKF6203}\} \)：轴承类型（与源域一致，保证故障物理机制共性）；
  - \( t_j^{\text{rpm}} \)：轴承转速（转/分钟），转换为频率\( t_j^{\text{fr}} = t_j^{\text{rpm}} / 60 \)（Hz，用于计算故障特征频率）；
  - \( t_j^{\text{n}}/t_j^{\text{d}}/t_j^{\text{D}} \)：滚动体数/滚动体直径/轴承节径（由\( t_j^{\text{bt}} \)查询`bearing_geometry_params.csv`得到，保证故障频率公式的共性）。
- **目标域特征矩阵**：\( X_t = [\mathbf{f}*{t,1}, \mathbf{f}*{t,2}, ..., \mathbf{f}*{t,16}]^T \in \mathbb{R}^{16 \times 13} \)，其中\( \mathbf{f}*{t,j} \)为目标域样本\( j \)的13维特征向量（与源域特征维度、提取方法完全一致，保证特征共性）。
- **目标域标签向量**：\( y_t = [y_{t,1}, ..., y_{t,16}]^T \in \mathbb{N}^{16 \times 1} \)，为目标域样本的预测故障标签。
- **DANN核心组件**：
  - 特征提取器\( G \)：输入13维特征，输出64维**域不变特征**（同时编码源域与目标域的故障信息，过滤域特异性噪声）；
  - 标签分类器\( C \)：输入域不变特征，输出4类故障概率（继承任务2的分类能力）；
  - 域分类器\( D \)：输入域不变特征，输出“源域/目标域”二分类概率（判别域差异）；
  - 梯度反转层（GRL）：连接\( G \)与\( D \)，反向传播时将梯度乘以\(-\lambda\)（\(\lambda\)为域对抗系数，平衡分类与域对齐）。

#### 三、问题三的参数设置与取值依据
- **迁移学习方法**：选用DANN，核心逻辑为“**分类任务约束共性特征学习**+**域对抗约束差异减少**”，完美匹配问题中“共性与差异兼顾”的要求。
- **模型结构参数**（基于故障诊断任务的轻量化需求与计算效率）：
  - 特征提取器\( G \)：2层全连接网络（13→64→64），激活函数为ReLU（避免梯度消失，捕捉非线性特征）；
  - 标签分类器\( C \)：1层全连接网络（64→4），激活函数为Softmax（多分类概率输出，继承任务2的诊断模型）；
  - 域分类器\( D \)：2层全连接网络（64→32→1），激活函数为Sigmoid（二分类概率输出，判别源域/目标域）。
- **超参数**（基于小样本目标域的过拟合控制与迁移效率）：
  - 学习率\( lr=0.001 \)：Adam优化器的默认学习率，平衡梯度稳定性与收敛速度；
  - 迭代次数\( epochs=100 \)：目标域仅16个样本，避免过拟合；
  - 批次大小\( batch_size=32 \)：源域161样本的合理mini-batch，兼顾梯度估计精度与训练速度；
  - 域对抗系数\( \lambda = \text{epochs}_{\text{current}} / \text{epochs} \)：线性递增（从0到1），初始优先学习分类任务，后期增强域对抗（符合DANN“渐进式域适应”的原始设计）；
  - 随机种子\( random_state=42 \)：保证实验可重复性。

#### 四、问题三的约束条件与数学表达
约束条件需**锚定问题核心目标**：保留源域分类能力（共性）、减少域分布差异（差异）。

1. **共性约束**（保证迁移的物理基础）：
   - **特征维度一致**：\( X_t \)的维度必须为16×13（与\( X_s \)的161×13一致），即目标域特征提取必须严格复制源域的**时域-频域-时频特征提取流程**：
     - 时域特征：\( \text{Peak}*j = \max(t_j^{\text{acc}}) \)（峰值）、\( \text{RMS}*j = \sqrt{\frac{1}{N}\sum*{k=1}^N a*{j,k}^2} \)（均方根）、\( \text{CrestFactor}_j = \text{Peak}_j / \text{RMS}*j \)（峰值因子）、\( \text{ImpulseFactor}*j = \text{Peak}*j / \left(\frac{1}{N}\sum*{k=1}^N |a*{j,k}|\right) \)（脉冲因子）、\( \text{Kurtosis}*j = \frac{\frac{1}{N}\sum*{k=1}^N (a*{j,k} - \mu_j)^4}{(\sigma_j)^2} \)（峭度，\( \mu_j \)为均值，\( \sigma_j \)为标准差）；
     - 频域特征：先计算理论故障频率（\( \text{BPFO}_j = t_j^{\text{fr}} \cdot \frac{t_j^{\text{n}}}{2} \cdot (1 - \frac{t_j^{\text{d}}}{t_j^{\text{D}}}) \)、\( \text{BPFI}_j = t_j^{\text{fr}} \cdot \frac{t_j^{\text{n}}}{2} \cdot (1 + \frac{t_j^{\text{d}}}{t_j^{\text{D}}}) \)、\( \text{BSF}_j = t_j^{\text{fr}} \cdot \frac{t_j^{\text{D}}}{t_j^{\text{d}}} \cdot [1 - (\frac{t_j^{\text{d}}}{t_j^{\text{D}}})^2] \)），再对\( t_j^{\text{acc}} \)做FFT得到频谱\( S_j(f) \)，取理论频率±5%范围内的最大幅值作为\( \text{Amp_BPFO}_j \)/\( \text{Amp_BPFI}_j \)/\( \text{Amp_BSF}_j \)；
     - 时频特征：用db4小波对\( t_j^{\text{acc}} \)做2层小波包分解，得到4个节点信号\( w_j^{(2,0)} \)-\( w_j^{(2,3)} \)，计算每个节点的能量占比\( \text{Energy_WP}*k_j = \frac{\sum*{m=1}^{N_k} w_j^{(2,k)}[m]^2}{\sum_{k=0}^3 \sum_{m=1}^{N_k} w_j^{(2,k)}[m]^2} \)（\( k=1-4 \)）。
   - **轴承类型一致**：\( t_j^{\text{bt}} \in \{\text{SKF6205}, \text{SKF6203}\} \)（与源域轴承类型相同），保证故障物理机制与频率公式的一致性。

2. **差异约束**（减少源域与目标域的分布偏移）：
   - **域对抗损失约束**：通过域分类器\( D \)判别特征的域归属，特征提取器\( G \)通过梯度反转层（GRL）对抗\( D \)的判别能力，强制学习**域不变特征**。数学表达为：
     - 域分类器的目标：最小化域分类损失\( L_{\text{dom}} \)（准确区分源域与目标域）；
     - 特征提取器的目标：通过GRL反转梯度，最大化\( L_{\text{dom}} \)（让\( D \)无法区分源域与目标域）。

#### 五、问题三的完整数学模型公式
模型需**分步骤拆解迁移逻辑**：特征提取→归一化→域不变特征学习→分类标定。

##### 1. 目标域特征提取模型（保证与源域的特征共性）
对每个目标域样本\( t_j \)，按**源域特征提取的完整流程**计算13维特征向量\( \mathbf{f}*{t,j} \)：\[
\mathbf{f}*{t,j} = \left[ \underbrace{\text{Peak}_j, \text{RMS}_j, \text{CrestFactor}_j, \text{ImpulseFactor}_j, \text{Kurtosis}*j}*{\text{时域5维}}, \underbrace{\text{Amp_BPFO}_j, \text{Amp_BPFI}_j, \text{Amp_BSF}*j}*{\text{频域3维}}, \underbrace{\text{Energy_WP1}_j, \text{Energy_WP2}_j, \text{Energy_WP3}_j, \text{Energy_WP4}*j}*{\text{时频4维}} \right]^T
\]其中各特征的计算严格遵循问题一的数学定义（如上述“共性约束”中的时域/频域/时频特征公式），确保与源域特征的**物理含义一致**。

##### 2. 目标域特征归一化模型（减少分布差异的预处理）
使用源域特征的**均值与标准差**对目标域特征标准化（避免目标域特征尺度偏移导致的迁移失败）：\[
X_{t,\text{scaled}}[j,f] = \frac{X_t[j,f] - \mu_{s,f}}{\sigma_{s,f}}
\]其中\( \mu_{s,f} = \frac{1}{161}\sum_{i=1}^{161} X_s[i,f] \)（源域特征\( f \)的均值），\( \sigma_{s,f} = \sqrt{\frac{1}{160}\sum_{i=1}^{161} (X_s[i,f] - \mu_{s,f})^2} \)（源域特征\( f \)的标准差），\( f=1 \)到13对应13维特征。

##### 3. DANN迁移模型（捕捉域不变特征+减少域差异）
DANN的核心是**双对抗任务**：标签分类任务（保留源域分类能力）与域分类任务（减少域差异）。

- **特征提取**：源域样本\( x_{s,i} \)与目标域样本\( x_{t,j} \)通过特征提取器\( G \)映射到**域不变特征空间**：\[
  z_{s,i} = G(x_{s,i}) = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x_{s,i} + b_1) + b_2), \quad z_{t,j} = G(x_{t,j}) = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x_{t,j} + b_1) + b_2)
  \]其中\( W_1 \in \mathbb{R}^{64 \times 13} \)、\( b_1 \in \mathbb{R}^{64} \)（第一层全连接权重/偏置），\( W_2 \in \mathbb{R}^{64 \times 64} \)、\( b_2 \in \mathbb{R}^{64} \)（第二层全连接权重/偏置），\( \text{ReLU}(x) = \max(0, x) \)（激活函数）。

- **标签分类**：域不变特征输入标签分类器\( C \)，输出故障概率（继承任务2的分类能力）：\[
  p_{s,i} = C(z_{s,i}) = \text{Softmax}(W_c z_{s,i} + b_c), \quad p_{t,j} = C(z_{t,j}) = \text{Softmax}(W_c z_{t,j} + b_c)
  \]其中\( W_c \in \mathbb{R}^{4 \times 64} \)、\( b_c \in \mathbb{R}^4 \)（分类器权重/偏置），\( \text{Softmax}(p)*k = \frac{\exp(p_k)}{\sum*{m=0}^3 \exp(p_m)} \)（多分类概率归一化，\( k=0-3 \)对应4类故障）。

- **域分类与梯度反转**：域不变特征通过GRL输入域分类器\( D \)，输出域归属概率（源域为1，目标域为0）：\[
  q_{s,i} = D(\text{GRL}(z_{s,i})) = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} z_{s,i} + b_{d1}) + b_{d2}), \quad q_{t,j} = D(\text{GRL}(z_{t,j})) = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} z_{t,j} + b_{d1}) + b_{d2})
  \]其中\( W_{d1} \in \mathbb{R}^{32 \times 64} \)、\( b_{d1} \in \mathbb{R}^{32} \)（域分类器第一层权重/偏置），\( W_{d2} \in \mathbb{R}^{1 \times 32} \)、\( b_{d2} \in \mathbb{R}^1 \)（域分类器第二层权重/偏置），\( \text{Sigmoid}(q) = \frac{1}{1 + \exp(-q)} \)（二分类概率归一化）。GRL的作用：**前向传播恒等映射**（\( \text{GRL}(z) = z \)），**反向传播梯度反转**（\(
  abla_z L_{\text{dom}} \to -\lambda
  abla_z L_{\text{dom}} \)），强制特征提取器对抗域分类器的判别能力。

##### 2. 损失函数与梯度计算（平衡分类与域对抗）
总损失由**标签分类损失**（保留源域分类能力）与**域分类损失**（减少域差异）组成：

- **标签分类损失**（交叉熵，衡量源域分类准确性）：\[
  L_{\text{cls}} = -\frac{1}{161} \sum_{i=1}^{161} \sum_{k=0}^3 y_{s,i,k} \log(p_{s,i,k})
  \]其中\( y_{s,i,k} \)为源域样本\( i \)的独热编码标签（若样本\( i \)的标签为\( k \)，则\( y_{s,i,k}=1 \)，否则为0），\( p_{s,i,k} \)为分类器对源域样本\( i \)的第\( k \)类预测概率。

- **域分类损失**（交叉熵，衡量域分类器的判别能力）：\[
  L_{\text{dom}} = -\frac{1}{177} \left( \sum_{i=1}^{161} \log(q_{s,i}) + \sum_{j=1}^{16} \log(1 - q_{t,j}) \right)
  \]其中177=161+16（源域+目标域总样本数），\( q_{s,i} \)为源域样本\( i \)的源域概率（目标为1），\( q_{t,j} \)为目标域样本\( j \)的源域概率（目标为0）。

- **总损失**：\[
  L_{\text{total}} = L_{\text{cls}} + L_{\text{dom}}
  \]

- **梯度计算**（通过反向传播优化模型参数）：
  - 标签分类器\( C \)的梯度：仅优化分类损失（保留分类能力）：\[

abla_C L_{\text{total}} =
abla_C L_{\text{cls}}
\]
- 域分类器\( D \)的梯度：仅优化域分类损失（准确区分域）：\[

abla_D L_{\text{total}} =
abla_D L_{\text{dom}}
\]
- 特征提取器\( G \)的梯度：通过GRL反转域损失的梯度，对抗\( D \)的判别能力：\[

abla_G L_{\text{total}} =
abla_G L_{\text{cls}} - \lambda
abla_G L_{\text{dom}}
\]

##### 3. 目标域分类标定模型（迁移学习的最终输出）
目标域样本\( j \)的预测标签为分类器输出概率最大的类别：\[
y_{t,j} = \arg\max_{k \in \{0,1,2,3\}} p_{t,j,k}
\]其中\( p_{t,j,k} = C(G(x_{t,j}))_k \)（目标域样本\( j \)的第\( k \)类预测概率），\( \arg\max \)取概率最大的类别索引（对应4类故障）。

### 模型的合理性说明
1. **共性捕捉**：通过严格一致的特征提取流程与维度约束，保证源域与目标域特征的**物理含义一致性**（如频域特征对应相同的故障频率、时频特征对应相同的小波包分解策略），为迁移学习提供了**故障判别的共同基础**。
2. **差异减少**：通过DANN的域对抗机制，特征提取器\( G \)强制学习**域不变特征**（同时适用于源域与目标域的故障判别特征），有效缓解了源域与目标域因转速不同导致的**分布偏移问题**。
3. **任务衔接**：标签分类器\( C \)直接继承任务2的诊断模型结构，保证了迁移学习对源域分类能力的**继承性**，避免了从头训练的低效性。

该模型完整覆盖了问题三的核心要求：基于任务2的诊断模型、考虑源域目标域的共性与差异、设计迁移学习方法、分类标定目标域样本。
### 问题三的模型求解算法介绍
问题三采用**领域对抗神经网络（Domain-Adversarial Neural Network, DANN）**作为核心迁移学习算法，其核心逻辑是：通过**特征提取器**学习同时编码源域与目标域故障信息的**域不变特征**（过滤转速差异等域特异性噪声），通过**标签分类器**保留源域的故障分类能力（继承任务2的诊断性能），通过**域分类器**与**梯度反转层（GRL）**的对抗训练，强制特征提取器生成“无法被域分类器区分来源”的特征（减少源域与目标域的分布偏移）。最终，利用训练好的特征提取器与标签分类器对目标域样本进行故障类型预测，实现跨域故障诊断。

DANN与问题三数学模型的适配性体现在：
1. **域不变特征捕捉**：特征提取器的结构与数学模型完全一致（13→64→64全连接+ReLU），直接对应“域不变特征空间”的构建；
2. **共性能力保留**：标签分类器继承任务2的结构（64→4全连接+Softmax），其分类损失约束严格对应数学模型中“保留源域分类能力”的共性要求；
3. **差异分布对齐**：域分类器（64→32→1全连接+Sigmoid）与GRL的对抗机制，通过数学模型中的“域对抗损失约束”定量缩小源域与目标域的分布偏移；
4. **渐进式迁移优化**：域对抗系数\(\lambda\)的线性递增策略（从0到1），完全遵循数学模型中“初始优先分类任务、后期增强域对抗”的设计逻辑。

### 问题三的模型求解步骤

#### 第一步：输入准备与参数初始化
**所需数据文件**：
- 源域特征数据集：`Source_Features.csv`（含13维特征与故障标签`Label`，对应数学模型中的\(X_s\)与\(y_s\)）；
- 目标域数据集：16个`.mat`文件（含时域振动信号`acceleration`、轴承属性`bearing_type`/`rpm`，对应数学模型中的\(\mathcal{T}\)）；
- 辅助表格：`bearing_geometry_params.csv`（轴承几何参数）与`fault_frequency_formula.csv`（故障频率公式，用于计算目标域理论故障频率）。

**核心变量与模型组件**：
- 源域特征矩阵\(X_s \in \mathbb{R}^{161 \times 13}\)、源域标签向量\(y_s \in \mathbb{N}^{161 \times 1}\)（对应数学模型中的定义）；
- 目标域数据集\(\mathcal{T} = \{t_1, t_2, ..., t_{16}\}\)（每个样本含时域信号\(t_j^{\text{acc}}\)、轴承类型\(t_j^{\text{bt}}\)、转速\(t_j^{\text{rpm}}\)）；
- 目标域特征矩阵\(X_t \in \mathbb{R}^{16 \times 13}\)（待提取，对应数学模型中的\(X_t\)）；
- DANN核心组件：
  - 特征提取器\(G\)：2层全连接网络（输入13维特征，输出64维域不变特征，对应数学模型中的\(G\)）；
  - 标签分类器\(C\)：1层全连接网络（输入64维域不变特征，输出4类故障概率，对应数学模型中的\(C\)）；
  - 域分类器\(D\)：2层全连接网络（输入64维域不变特征，输出源域/目标域二分类概率，对应数学模型中的\(D\)）；
  - 梯度反转层（GRL）：连接\(G\)与\(D\)，前向传播恒等映射、反向传播梯度反转（对应数学模型中的GRL）。

**参数设置（严格对应数学模型）**：
- 模型结构参数：
  - 特征提取器\(G\)：13→64→64全连接层，激活函数ReLU；
  - 标签分类器\(C\)：64→4全连接层，激活函数Softmax；
  - 域分类器\(D\)：64→32→1全连接层，激活函数Sigmoid；
- 超参数：
  - 学习率\(lr=0.001\)（Adam优化器）；
  - 迭代次数\(epochs=100\)；
  - 批次大小\(batch_size=32\)（源域样本的mini-batch划分）；
  - 域对抗系数\(\lambda = \text{epochs}_{\text{current}} / \text{epochs}\)（线性递增，从0到1）；
  - 随机种子\(random_state=42\)（保证可重复性）。

**约束条件（严格对应数学模型）**：
- 目标域特征维度必须为16×13（与源域一致）；
- 目标域轴承类型\(t_j^{\text{bt}} \in \{\text{SKF6205}, \text{SKF6203}\}\)（与源域一致，保证故障物理机制共性）；
- 目标域特征提取流程必须与源域完全一致（时域、频域、时频特征的计算方法严格遵循数学模型中的公式）；
- 目标域特征标准化必须使用源域特征的均值\(\mu_{s,f}\)与标准差\(\sigma_{s,f}\)（避免尺度偏移）。

#### 第二步：目标域特征提取与标准化
**目标**：将目标域时域信号转换为与源域一致的13维特征，并消除尺度差异，对应数学模型中的“目标域特征提取模型”与“目标域特征归一化模型”。

1. **时域特征计算**：对每个目标域样本\(t_j\)的加速度信号\(t_j^{\text{acc}}\)，按数学模型中的公式计算：
   - 峰值：\(\text{Peak}_j = \max(t_j^{\text{acc}})\)；
   - 均方根值：\(\text{RMS}*j = \sqrt{\frac{1}{N}\sum*{k=1}^N a_{j,k}^2}\)（\(N\)为采样点数，\(a_{j,k}\)为\(t_j^{\text{acc}}\)的第\(k\)个采样值）；
   - 峰值因子：\(\text{CrestFactor}_j = \text{Peak}_j / \text{RMS}_j\)；
   - 脉冲因子：\(\text{ImpulseFactor}*j = \text{Peak}*j / \left(\frac{1}{N}\sum*{k=1}^N |a*{j,k}|\right)\)；
   - 峭度：\(\text{Kurtosis}*j = \frac{\frac{1}{N}\sum*{k=1}^N (a_{j,k} - \mu_j)^4}{(\sigma_j)^2}\)（\(\mu_j\)为\(t_j^{\text{acc}}\)的均值，\(\sigma_j\)为标准差）。

2. **频域特征计算**：
   - 转速频率转换：\(t_j^{\text{fr}} = t_j^{\text{rpm}} / 60\)（Hz，对应数学模型中的\(t_j^{\text{fr}}\)）；
   - 几何参数查询：通过\(t_j^{\text{bt}}\)从`bearing_geometry_params.csv`获取滚动体数\(t_j^{\text{n}}\)、滚动体直径\(t_j^{\text{d}}\)、轴承节径\(t_j^{\text{D}}\)；
   - 理论故障频率计算：按数学模型中的公式计算外圈故障频率\(\text{BPFO}_j\)、内圈故障频率\(\text{BPFI}_j\)、滚动体故障频率\(\text{BSF}_j\)；
   - 频谱幅值提取：对\(t_j^{\text{acc}}\)做FFT得到频谱\(S_j(f)\)，取理论故障频率±5%范围内的最大幅值作为\(\text{Amp_BPFO}_j\)、\(\text{Amp_BPFI}_j\)、\(\text{Amp_BSF}_j\)（对应数学模型中的频域特征定义）。

3. **时频特征计算**：
   - 小波包分解：用db4小波对\(t_j^{\text{acc}}\)做2层分解，得到4个节点信号\(w_j^{(2,0)}\)至\(w_j^{(2,3)}\)（对应数学模型中的时频特征分解方式）；
   - 能量占比计算：按数学模型中的公式计算每个节点的能量占比\(\text{Energy_WP1}_j\)至\(\text{Energy_WP4}_j\)。

4. **特征标准化**：用源域特征的均值\(\mu_{s,f}\)与标准差\(\sigma_{s,f}\)（从`Source_Features.csv`计算得到）对目标域特征矩阵\(X_t\)标准化，公式为：\[
   X_{t,\text{scaled}}[j,f] = \frac{X_t[j,f] - \mu_{s,f}}{\sigma_{s,f}}
   \]其中\(j\)为目标域样本索引（1≤j≤16），\(f\)为特征索引（1≤f≤13）。

#### 第三步：DANN模型构建
**目标**：构建DANN的网络结构，明确各组件的连接关系与前向传播逻辑，对应数学模型中的“DANN迁移模型”。

1. **特征提取器\(G\)**：输入源域/目标域的13维特征（标准化后），输出64维域不变特征，前向传播公式为：\[
   z = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x + b_1) + b_2)
   \]其中\(W_1 \in \mathbb{R}^{64 \times 13}\)、\(b_1 \in \mathbb{R}^{64}\)为第一层全连接的权重与偏置，\(W_2 \in \mathbb{R}^{64 \times 64}\)、\(b_2 \in \mathbb{R}^{64}\)为第二层全连接的权重与偏置，\(x\)为输入特征向量，\(z\)为域不变特征。

2. **标签分类器\(C\)**：输入域不变特征\(z\)，输出4类故障概率，前向传播公式为：\[
   p = \text{Softmax}(W_c z + b_c)
   \]其中\(W_c \in \mathbb{R}^{4 \times 64}\)、\(b_c \in \mathbb{R}^4\)为分类器的权重与偏置，\(p_k\)为第\(k\)类故障的预测概率（\(k=0,1,2,3\)对应正常、内圈、外圈、滚动体故障）。

3. **域分类器\(D\)与梯度反转层（GRL）**：输入域不变特征\(z\)（经GRL层），输出源域/目标域的二分类概率，前向传播公式为：\[
   q = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} \cdot \text{GRL}(z) + b_{d1}) + b_{d2})
   \]其中\(W_{d1} \in \mathbb{R}^{32 \times 64}\)、\(b_{d1} \in \mathbb{R}^{32}\)为域分类器第一层的权重与偏置，\(W_{d2} \in \mathbb{R}^{1 \times 32}\)、\(b_{d2} \in \mathbb{R}^1\)为第二层的权重与偏置；GRL层的作用为：前向传播时\(\text{GRL}(z) = z\)（恒等映射），反向传播时将梯度乘以\(-\lambda\)（梯度反转）。

#### 第四步：DANN联合训练
**目标**：通过双任务（分类+域对抗）优化DANN的参数，对应数学模型中的“损失函数与梯度计算”。

1. **数据加载与批次生成**：
   - 加载源域特征矩阵\(X_s\)、源域标签向量\(y_s\)（带标签）；
   - 加载目标域标准化特征矩阵\(X_{t,\text{scaled}}\)（无标签）；
   - 对源域数据进行随机打乱，按\(batch_size=32\)生成mini-batch；对目标域数据按同样批次大小生成mini-batch（若目标域样本数不足，重复采样补足）。

2. **前向传播**：
   - 对每个源域mini-batch\(\{x_s^b, y_s^b\}\)，通过特征提取器\(G\)得到域不变特征\(z_s^b = G(x_s^b)\)，通过标签分类器\(C\)得到分类概率\(p_s^b = C(z_s^b)\)，通过GRL层与域分类器\(D\)得到域概率\(q_s^b = D(\text{GRL}(z_s^b))\)；
   - 对每个目标域mini-batch\(\{x_t^b\}\)，通过特征提取器\(G\)得到域不变特征\(z_t^b = G(x_t^b)\)，通过GRL层与域分类器\(D\)得到域概率\(q_t^b = D(\text{GRL}(z_t^b))\)（无标签，不计算分类概率）。

3. **损失计算**：
   - **标签分类损失\(L_{\text{cls}}\)**：仅用源域数据计算交叉熵损失，公式为：\[
     L_{\text{cls}} = -\frac{1}{|B_s|} \sum_{i \in B_s} \sum_{k=0}^3 y_{s,i,k} \log(p_{s,i,k})
     \]其中\(|B_s|\)为源域mini-batch的大小，\(y_{s,i,k}\)为源域样本\(i\)的独热编码标签（若样本\(i\)的标签为\(k\)，则\(y_{s,i,k}=1\)，否则为0），\(p_{s,i,k}\)为分类器对源域样本\(i\)的第\(k\)类预测概率。
   - **域分类损失\(L_{\text{dom}}\)**：用源域与目标域数据计算交叉熵损失，公式为：\[
     L_{\text{dom}} = -\frac{1}{|B_s| + |B_t|} \left( \sum_{i \in B_s} \log(q_{s,i}) + \sum_{j \in B_t} \log(1 - q_{t,j}) \right)
     \]其中\(|B_t|\)为目标域mini-batch的大小，\(q_{s,i}\)为源域样本\(i\)的源域概率（目标值为1），\(q_{t,j}\)为目标域样本\(j\)的源域概率（目标值为0）。
   - **总损失\(L_{\text{total}}\)**：将分类损失与域损失加权求和，公式为：\[
     L_{\text{total}} = L_{\text{cls}} + L_{\text{dom}}
     \]

4. **梯度计算与参数更新**：
   - 对标签分类器\(C\)：仅计算分类损失的梯度，更新参数：\[

abla_C L_{\text{total}} =
abla_C L_{\text{cls}}
\]
- 对域分类器\(D\)：仅计算域损失的梯度，更新参数：\[

abla_D L_{\text{total}} =
abla_D L_{\text{dom}}
\]
- 对特征提取器\(G\)：通过GRL层反转域损失的梯度，计算总梯度并更新参数：\[

abla_G L_{\text{total}} =
abla_G L_{\text{cls}} - \lambda
abla_G L_{\text{dom}}
\]
- 所有参数通过Adam优化器更新，学习率为\(lr=0.001\)。

5. **迭代训练**：重复上述步骤，迭代\(epochs=100\)次；每轮迭代中，域对抗系数\(\lambda\)按\(\lambda = \text{current_epoch} / \text{total_epochs}\)线性递增（从0到1），初始阶段优先优化分类任务，后期增强域对抗能力。

#### 第五步：目标域分类标定
**目标**：用训练好的DANN模型预测目标域样本的故障类型，对应数学模型中的“目标域分类标定模型”。

1. **特征投影**：将标准化后的目标域特征矩阵\(X_{t,\text{scaled}}\)输入特征提取器\(G\)，得到域不变特征矩阵\(Z_t = G(X_{t,\text{scaled}})\)（维度为16×64）。

2. **故障类型预测**：将域不变特征矩阵\(Z_t\)输入标签分类器\(C\)，得到每个目标域样本的4类故障概率\(P_t = C(Z_t)\)（维度为16×4）；对每个样本\(j\)，取概率最大的类别作为最终标签，公式为：\[
   y_{t,j} = \arg\max_{k \in \{0,1,2,3\}} P_{t,j,k}
   \]其中\(P_{t,j,k}\)为目标域样本\(j\)的第\(k\)类预测概率，\(y_{t,j}\)为样本\(j\)的故障标签（0=正常、1=内圈、2=外圈、3=滚动体）。

#### 第六步：输出结果
**目标**：生成问题三要求的输出内容，具体包括：
1. **目标域特征矩阵**：每个目标域样本的13维特征（时域5维、频域3维、时频4维）；
2. **训练好的DANN模型**：特征提取器\(G\)、标签分类器\(C\)、域分类器\(D\)的权重与偏置参数；
3. **目标域分类结果**：16个目标域样本的预测故障标签向量\(y_t\)；
4. **迁移结果可视化**：标签分类损失与域分类损失随迭代次数的变化曲线、源域与目标域域不变特征的PCA散点图（2维）、目标域样本各故障类型的预测置信度分布；
5. **迁移结果分析**：源域与目标域的分布差异减小情况（通过域分类损失曲线）、目标域各故障类型的预测置信度分布特征。
