### 问题三的要求
在任务2设计的诊断模型基础上，充分考虑源域与目标域的**共性特征**（轴承类型一致、特征维度一致、故障物理机制一致）与**差异特征**（转速不同导致的频域分布差异、数据分布偏移），设计基于领域对抗神经网络（DANN）的迁移学习方法，构建目标域诊断模型：通过特征提取器捕捉**域不变特征**（同时适用于源域与目标域的故障判别特征），通过域对抗机制减少**域分布差异**（源域与目标域的特征分布偏移），最终对目标域16个未知标签样本进行分类标定，并可视化迁移效果。

### 问题三的完整数学模型建立

#### 一、模型假设
为保证迁移学习的合理性与可行性，基于问题要求与故障诊断任务的物理特性，提出以下假设（每条假设均阐明依据）：
1. **故障物理机制一致性假设**：源域与目标域的轴承类型均为SKF6205或SKF6203，因此故障产生的物理机制（如故障频率的计算方式、振动信号的调制特性）完全相同。依据：问题明确将“轴承类型一致、故障物理机制一致”列为源域与目标域的共性特征，这是迁移学习的核心物理基础。
2. **特征提取一致性假设**：目标域特征提取流程与源域严格一致（时域、频域、时频特征的计算方法完全相同），因此目标域特征与源域特征的物理含义完全匹配。依据：问题要求“特征维度一致”是共性特征，只有通过相同的提取流程，才能保证特征对故障信息的编码方式一致，为域不变特征学习提供前提。
3. **主要差异来源假设**：源域与目标域的特征分布偏移主要来自转速不同导致的频域特征分布差异，其他差异（如测量噪声、环境干扰）可忽略。依据：问题明确将“转速不同导致的频域分布差异、数据分布偏移”列为主要差异特征，因此模型只需聚焦于消除转速带来的分布偏移。
4. **无监督域适应假设**：目标域样本无标签，需通过无监督域适应（Unsupervised Domain Adaptation, UDA）方法学习域不变特征。依据：问题中目标域是“未知标签样本”，传统有监督学习无法直接应用，需通过DANN这类无监督迁移方法利用源域标签信息。

#### 二、变量定义与物理含义
为准确描述源域、目标域的特征与模型组件，定义以下变量（所有变量均关联物理含义，明确其在迁移学习中的作用）：
- **源域特征矩阵**：\( X_s = [\mathbf{x}*{s,1}, \mathbf{x}*{s,2}, ..., \mathbf{x}*{s,161}]^T \in \mathbb{R}^{161 \times 13} \)，其中第\( i \)行\( \mathbf{x}*{s,i} \)是源域样本\( i \)的13维特征向量，包含**时域5维**（峰值\(\text{Peak}_i\)、均方根\(\text{RMS}_i\)、峰值因子\(\text{CrestFactor}_i\)、脉冲因子\(\text{ImpulseFactor}_i\)、峭度\(\text{Kurtosis}_i\)）、**频域3维**（外圈故障频率幅值\(\text{Amp_BPFO}_i\)、内圈故障频率幅值\(\text{Amp_BPFI}_i\)、滚动体故障频率幅值\(\text{Amp_BSF}_i\)）、**时频4维**（小波包分解能量占比\(\text{Energy_WP1}_i\)-\(\text{Energy_WP4}_i\)）。这些特征编码了源域样本的故障信息，是任务2诊断模型的输入。
- **源域标签向量**：\( y_s = [y_{s,1}, y_{s,2}, ..., y_{s,161}]^T \in \mathbb{N}^{161 \times 1} \)，\( y_{s,i} \in \{0,1,2,3\} \)对应源域样本\( i \)的故障类型（0=正常、1=内圈故障、2=外圈故障、3=滚动体故障）。标签是监督学习的“ground truth”，用于训练标签分类器。
- **目标域样本集合**：\( \mathcal{T} = \{t_1, t_2, ..., t_{16}\} \)，每个样本\( t_j \)包含：
  - \( t_j^{\text{acc}} = [a_{j,1}, a_{j,2}, ..., a_{j,N}]^T \in \mathbb{R}^N \)：时域振动加速度信号（\( N \)为采样点数，时长4秒），是特征提取的原始数据；
  - \( t_j^{\text{bt}} \in \{\text{SKF6205}, \text{SKF6203}\} \)：轴承类型，用于查询几何参数以计算故障频率；
  - \( t_j^{\text{rpm}} \)：转速（转/分钟），转换为转速频率\( t_j^{\text{fr}} = t_j^{\text{rpm}} / 60 \)（Hz），是频域特征分布偏移的主要来源；
  - \( t_j^{\text{n}}/t_j^{\text{d}}/t_j^{\text{D}} \)：滚动体数/滚动体直径/轴承节径（由\( t_j^{\text{bt}} \)查询`bearing_geometry_params.csv`得到），用于计算理论故障频率。
- **目标域特征矩阵**：\( X_t = [\mathbf{f}*{t,1}, \mathbf{f}*{t,2}, ..., \mathbf{f}*{t,16}]^T \in \mathbb{R}^{16 \times 13} \)，其中\( \mathbf{f}*{t,j} \)是目标域样本\( j \)的13维特征向量，**与源域特征维度、提取方法完全一致**，用于保证特征的物理含义一致性。
- **目标域标签向量**：\( y_t = [y_{t,1}, ..., y_{t,16}]^T \in \mathbb{N}^{16 \times 1} \)，是目标域样本的预测故障标签，为模型的最终输出。
- **DANN核心组件**：
  - 特征提取器\( G \)：输入13维特征，输出64维**域不变特征**\( z \)，作用是过滤源域与目标域的特异性噪声（如转速差异），保留对故障判别有用的共性信息；
  - 标签分类器\( C \)：输入域不变特征\( z \)，输出4类故障概率\( p \)，作用是继承任务2的诊断能力，利用源域标签监督共性特征学习；
  - 域分类器\( D \)：输入域不变特征\( z \)，输出“源域/目标域”二分类概率\( q \)，作用是判别特征的域归属，为域对抗提供监督信号；
  - 梯度反转层（GRL）：连接\( G \)与\( D \)，前向传播时恒等映射（\( \text{GRL}(z) = z \)），反向传播时将梯度乘以\(-\lambda\)（\(\lambda\)为域对抗系数），作用是强制特征提取器\( G \)对抗域分类器\( D \)的判别能力，学习域不变特征。

#### 三、参数设置与取值依据
为平衡模型性能与计算效率，基于故障诊断任务的轻量化需求与小样本目标域的过拟合控制，设置以下参数（每个参数均说明取值依据）：
- **模型结构参数**：
  - 特征提取器\( G \)：2层全连接网络（13→64→64），激活函数ReLU。依据：ReLU可避免梯度消失，2层全连接网络既能捕捉非线性特征，又不会因模型过深导致过拟合（源域仅161样本）。
  - 标签分类器\( C \)：1层全连接网络（64→4），激活函数Softmax。依据：Softmax用于多分类概率输出，1层结构继承任务2的诊断模型，保证分类能力的连续性。
  - 域分类器\( D \)：2层全连接网络（64→32→1），激活函数Sigmoid。依据：Sigmoid用于二分类概率输出，2层结构可有效判别域归属，复杂度与特征提取器匹配。
- **超参数**：
  - 学习率\( lr = 0.001 \)：Adam优化器的默认学习率，平衡梯度稳定性与收敛速度。依据：Adam对学习率不敏感，0.001是经验最优值，适合小样本训练。
  - 迭代次数\( epochs = 100 \)：目标域仅16样本，避免过拟合。依据：迭代次数过多会导致模型过度拟合源域噪声，100次是小样本任务的合理选择。
  - 批次大小\( batch_size = 32 \)：源域161样本的合理mini-batch，兼顾梯度估计精度与训练速度。依据：batch_size过大会降低梯度多样性，过小会增加训练波动，32是经验最优值。
  - 域对抗系数\( \lambda = \text{current_epoch} / \text{total_epochs} \)：线性递增（0→1）。依据：初始阶段优先优化分类任务（\(\lambda\)小），后期增强域对抗（\(\lambda\)大），符合DANN“渐进式域适应”的原始设计，避免早期域对抗破坏分类能力。
  - 随机种子\( random_state = 42 \)：保证实验可重复性。依据：固定随机种子可让模型初始化、数据打乱等操作一致，便于结果验证。

#### 四、约束条件与数学表达
约束条件是模型的“规则边界”，需锚定“保留共性、减少差异”的核心目标，以下约束均用公式呈现，并详细阐述其物理意义：

1. **共性约束：特征物理含义一致性**为保证源域与目标域特征的物理含义一致，目标域特征提取流程必须与源域严格相同，具体约束如下：
   - **时域特征约束**：目标域样本\( j \)的时域特征需通过以下公式计算（与源域完全一致）：\[
     \text{Peak}*j = \max(t_j^{\text{acc}}), \quad \text{RMS}*j = \sqrt{\frac{1}{N}\sum*{k=1}^N a*{j,k}^2}, \quad \text{CrestFactor}*j = \frac{\text{Peak}*j}{\text{RMS}*j}, \quad \text{ImpulseFactor}*j = \frac{\text{Peak}*j}{\frac{1}{N}\sum*{k=1}^N |a*{j,k}|}, \quad \text{Kurtosis}*j = \frac{\frac{1}{N}\sum*{k=1}^N (a*{j,k} - \mu_j)^4}{(\sigma_j)^2}
     \]其中\( \mu_j = \frac{1}{N}\sum*{k=1}^N a*{j,k} \)（\( t_j^{\text{acc}} \)的均值），\( \sigma_j = \sqrt{\frac{1}{N}\sum_{k=1}^N (a_{j,k} - \mu_j)^2} \)（\( t_j^{\text{acc}} \)的标准差）。解释：时域特征反映振动信号的幅度统计特性，是故障诊断的基础特征，严格一致的计算方式保证了特征对“故障导致的幅度异常”的编码一致。
   - **频域特征约束**：目标域样本\( j \)的频域特征需先计算理论故障频率（与源域公式一致），再提取频谱幅值：\[
     \text{BPFO}_j = t_j^{\text{fr}} \cdot \frac{t_j^{\text{n}}}{2} \cdot \left(1 - \frac{t_j^{\text{d}}}{t_j^{\text{D}}}\right), \quad \text{BPFI}_j = t_j^{\text{fr}} \cdot \frac{t_j^{\text{n}}}{2} \cdot \left(1 + \frac{t_j^{\text{d}}}{t_j^{\text{D}}}\right), \quad \text{BSF}_j = t_j^{\text{fr}} \cdot \frac{t_j^{\text{D}}}{t_j^{\text{d}}} \cdot \left[1 - \left(\frac{t_j^{\text{d}}}{t_j^{\text{D}}}\right)^2\right]
     \]对\( t_j^{\text{acc}} \)做FFT得到频谱\( S_j(f) \)后，取理论频率±5%范围内的最大幅值作为频域特征：\[
     \text{Amp_BPFO}_j = \max\{S_j(f) \mid f \in [0.95\text{BPFO}_j, 1.05\text{BPFO}_j]\}, \quad \text{Amp_BPFI}_j = \max\{S_j(f) \mid f \in [0.95\text{BPFI}_j, 1.05\text{BPFI}_j]\}, \quad \text{Amp_BSF}_j = \max\{S_j(f) \mid f \in [0.95\text{BSF}_j, 1.05\text{BSF}_j]\}
     \]解释：频域特征反映故障的周期性振动特性，理论故障频率由轴承几何参数与转速决定，严格一致的计算方式保证了特征对“故障导致的频率成分”的编码一致，即使转速不同，特征仍能定位到对应的故障频率band。
   - **时频特征约束**：目标域样本\( j \)的时频特征需通过db4小波2层分解计算能量占比（与源域一致）：对\( t_j^{\text{acc}} \)做2层小波包分解，得到4个节点信号\( w_j^{(2,0)}, w_j^{(2,1)}, w_j^{(2,2)}, w_j^{(2,3)} \)，计算每个节点的能量占比：\[
     \text{Energy_WP}*k_j = \frac{\sum*{m=1}^{N_k} (w_j^{(2,k)}[m])^2}{\sum_{k=0}^3 \sum_{m=1}^{N_k} (w_j^{(2,k)}[m])^2}, \quad k=0,1,2,3
     \]取前4个节点（对应\( k=0-3 \)）的能量占比作为时频特征（\( \text{Energy_WP1}_j \)-\( \text{Energy_WP4}_j \)）。解释：时频特征反映振动信号的频率成分随时间的变化，db4小波是故障诊断中常用的小波基，2层分解的节点数与源域一致，保证了特征对“故障导致的时频分布变化”的编码一致。

2. **差异约束：域分布偏移最小化**为减少源域与目标域的分布偏移，需通过域对抗机制强制特征提取器学习域不变特征，具体约束如下：
   - **域分类器目标约束**：域分类器\( D \)需最小化域分类损失\( L_{\text{dom}} \)，准确区分源域与目标域特征：\[
     \min_D L_{\text{dom}} = -\frac{1}{M+K} \left( \sum_{i=1}^M \log(q_{s,i}) + \sum_{j=1}^K \log(1 - q_{t,j}) \right)
     \]其中\( M=161 \)（源域样本数），\( K=16 \)（目标域样本数），\( q_{s,i} = D(G(x_{s,i})) \)（源域样本\( i \)的源域概率），\( q_{t,j} = D(G(x_{t,j})) \)（目标域样本\( j \)的源域概率）。解释：域分类损失是二分类交叉熵，目标是让域分类器\( D \)尽可能准确判别特征的域归属，为特征提取器\( G \)提供“对抗目标”。
   - **特征提取器目标约束**：特征提取器\( G \)需通过GRL反转梯度，最大化域分类损失\( L_{\text{dom}} \)，让域分类器\( D \)无法区分源域与目标域特征：\[
     \max_G L_{\text{dom}} \quad \text{s.t.} \quad
     abla_G L_{\text{dom}} \leftarrow -\lambda
     abla_G L_{\text{dom}}
     \]其中\( \lambda \)是域对抗系数（线性递增：\( \lambda = \text{current_epoch} / \text{total_epochs} \)）。解释：GRL的梯度反转机制让特征提取器\( G \)的优化目标与域分类器\( D \)相反，强制\( G \)学习到“域分类器无法区分”的特征，即域不变特征，从而减少分布偏移。

#### 五、数学模型完整公式推导
模型推导遵循“目标域特征提取→特征归一化→域不变特征学习→分类标定”的逻辑链，每个公式均说明推导目标与前后关联：

1. **步骤1：目标域特征提取——构建与源域一致的特征空间**目标：将目标域时域信号转换为13维特征，保证与源域特征的物理含义一致。对每个目标域样本\( t_j \)，按源域特征提取流程计算13维特征向量\( \mathbf{f}*{t,j} \)：\[
   \mathbf{f}*{t,j} = \left[ \text{Peak}_j, \text{RMS}_j, \text{CrestFactor}_j, \text{ImpulseFactor}_j, \text{Kurtosis}_j, \text{Amp_BPFO}_j, \text{Amp_BPFI}_j, \text{Amp_BSF}_j, \text{Energy_WP1}_j, \text{Energy_WP2}_j, \text{Energy_WP3}*j, \text{Energy_WP4}*j \right]^T
   \]解释：该公式是时域、频域、时频特征的组合，通过前面的子特征约束（时域、频域、时频特征公式）保证了\( \mathbf{f}*{t,j} \)与源域特征\( \mathbf{x}*{s,i} \)的物理含义一致，为后续的域不变特征学习铺垫了“共同特征空间”。

2. **步骤2：特征归一化——消除尺度差异**目标：消除源域与目标域特征的尺度差异（如不同转速导致的幅值差异），避免尺度偏移影响模型训练。使用源域特征的均值\( \mu_{s,f} \)与标准差\( \sigma_{s,f} \)对目标域特征标准化：\[
   X_{t,\text{scaled}}[j,f] = \frac{X_t[j,f] - \mu_{s,f}}{\sigma_{s,f}}, \quad f=1,2,...,13
   \]其中\( \mu_{s,f} = \frac{1}{M}\sum_{i=1}^M X_s[i,f] \)（源域特征\( f \)的均值），\( \sigma_{s,f} = \sqrt{\frac{1}{M-1}\sum_{i=1}^M (X_s[i,f] - \mu_{s,f})^2} \)（源域特征\( f \)的标准差），\( M=161 \)（源域样本数）。解释：标准化将特征转换为零均值、单位方差的分布，消除了不同特征之间的尺度差异（如峰值的量级远大于能量占比），同时使用源域的均值与标准差，保证了目标域特征的尺度与源域一致，避免了目标域自身尺度带来的分布偏移。

3. **步骤3：DANN迁移学习——学习域不变特征**目标：通过双对抗任务（标签分类+域分类）让特征提取器学习到同时适用于源域与目标域的域不变特征。DANN的核心是“分类任务约束共性特征学习，域对抗任务约束差异减少”，具体公式如下：
   - **特征提取**：源域样本\( x_{s,i} \)与目标域样本\( x_{t,j} \)通过特征提取器\( G \)映射到域不变特征空间：\[
     z_{s,i} = G(x_{s,i}) = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x_{s,i} + b_1) + b_2), \quad z_{t,j} = G(x_{t,j}) = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x_{t,j} + b_1) + b_2)
     \]其中\( W_1 \in \mathbb{R}^{64 \times 13} \)、\( b_1 \in \mathbb{R}^{64} \)是第一层全连接的权重与偏置，\( W_2 \in \mathbb{R}^{64 \times 64} \)、\( b_2 \in \mathbb{R}^{64} \)是第二层全连接的权重与偏置，\( \text{ReLU}(x) = \max(0, x) \)是激活函数。解释：特征提取器\( G \)的作用是将输入特征映射到高维空间，ReLU激活函数引入非线性，让模型能捕捉复杂的故障特征。
   - **标签分类**：域不变特征输入标签分类器\( C \)，输出故障概率（继承任务2的分类能力）：\[
     p_{s,i} = C(z_{s,i}) = \text{Softmax}(W_c z_{s,i} + b_c), \quad p_{t,j} = C(z_{t,j}) = \text{Softmax}(W_c z_{t,j} + b_c)
     \]其中\( W_c \in \mathbb{R}^{4 \times 64} \)、\( b_c \in \mathbb{R}^4 \)是分类器的权重与偏置，\( \text{Softmax}(p)*k = \frac{\exp(p_k)}{\sum*{m=0}^3 \exp(p_m)} \)是多分类概率归一化函数（\( k=0-3 \)对应4类故障）。解释：标签分类器\( C \)的作用是利用源域标签监督特征提取器\( G \)学习对故障判别有用的特征，Softmax输出让模型能给出每个类别的概率，便于后续分类标定。
   - **域分类与梯度反转**：域不变特征通过GRL输入域分类器\( D \)，输出域归属概率：\[
     q_{s,i} = D(\text{GRL}(z_{s,i})) = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} z_{s,i} + b_{d1}) + b_{d2}), \quad q_{t,j} = D(\text{GRL}(z_{t,j})) = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} z_{t,j} + b_{d1}) + b_{d2})
     \]其中\( W_{d1} \in \mathbb{R}^{32 \times 64} \)、\( b_{d1} \in \mathbb{R}^{32} \)是域分类器第一层的权重与偏置，\( W_{d2} \in \mathbb{R}^{1 \times 32} \)、\( b_{d2} \in \mathbb{R}^1 \)是第二层的权重与偏置，\( \text{Sigmoid}(q) = \frac{1}{1 + \exp(-q)} \)是二分类概率归一化函数。解释：域分类器\( D \)的作用是判别特征的域归属，GRL的梯度反转机制让特征提取器\( G \)的优化目标与\( D \)相反，强制\( G \)学习到域不变特征。

4. **步骤4：损失函数——平衡分类与域对抗**目标：通过总损失函数平衡标签分类任务与域分类任务，保证模型同时保留分类能力与减少分布偏移。总损失由标签分类损失\( L_{\text{cls}} \)与域分类损失\( L_{\text{dom}} \)组成：
   - **标签分类损失**：衡量源域分类准确性，使用多分类交叉熵：\[
     L_{\text{cls}} = -\frac{1}{M} \sum_{i=1}^M \sum_{k=0}^3 y_{s,i,k} \log(p_{s,i,k})
     \]其中\( y_{s,i,k} \)是源域样本\( i \)的独热编码标签（若样本\( i \)的标签为\( k \)，则\( y_{s,i,k}=1 \)，否则为0），\( p_{s,i,k} \)是分类器对源域样本\( i \)的第\( k \)类预测概率。解释：标签分类损失是监督学习的核心损失，保证模型能利用源域标签学习到对故障判别有用的特征。
   - **域分类损失**：衡量域分类器的判别能力，使用二分类交叉熵：\[
     L_{\text{dom}} = -\frac{1}{M+K} \left( \sum_{i=1}^M \log(q_{s,i}) + \sum_{j=1}^K \log(1 - q_{t,j}) \right)
     \]解释：域分类损失是域对抗的核心损失，让域分类器能准确判别特征的域归属，为特征提取器提供对抗目标。
   - **总损失**：\[
     L_{\text{total}} = L_{\text{cls}} + L_{\text{dom}}
     \]解释：总损失将分类任务与域对抗任务结合，保证模型在保留分类能力的同时，减少域分布偏移。

5. **步骤5：梯度计算——反向传播优化模型参数**目标：通过反向传播计算各组件的梯度，优化模型参数。各组件的梯度计算如下：
   - **标签分类器\( C \)的梯度**：仅优化分类损失（保留分类能力）：\[

abla_C L_{\text{total}} =
abla_C L_{\text{cls}}
\]解释：标签分类器的目标是准确分类源域样本，因此只需优化分类损失，无需考虑域对抗。
- **域分类器\( D \)的梯度**：仅优化域分类损失（准确区分域）：\[

abla_D L_{\text{total}} =
abla_D L_{\text{dom}}
\]解释：域分类器的目标是准确判别域归属，因此只需优化域分类损失，无需考虑分类任务。
- **特征提取器\( G \)的梯度**：通过GRL反转域损失的梯度，对抗域分类器的判别能力：\[

abla_G L_{\text{total}} =
abla_G L_{\text{cls}} - \lambda
abla_G L_{\text{dom}}
\]解释：特征提取器的目标是同时满足分类任务与域对抗任务，因此梯度由分类损失的梯度（正向）与域损失的梯度（反向，通过\(-\lambda\)反转）组成，\(\lambda\)线性递增保证了初始阶段优先优化分类任务，后期增强域对抗。

6. **步骤6：目标域分类标定——输出预测标签**目标：用训练好的模型预测目标域样本的故障类型。目标域样本\( j \)的预测标签为分类器输出概率最大的类别：\[
   y_{t,j} = \arg\max_{k \in \{0,1,2,3\}} p_{t,j,k}
   \]其中\( p_{t,j,k} = C(G(x_{t,j}))_k \)是目标域样本\( j \)的第\( k \)类预测概率，\( \arg\max \)是取概率最大的类别索引（对应4类故障）。解释：分类标定是模型的最终输出，通过取概率最大值，让模型能给出最可能的故障类型，保证结果的可解释性。

### 问题三的模型求解算法介绍

#### 一、算法选择：领域对抗神经网络（DANN）
DANN是无监督域适应的经典算法，核心逻辑是“通过特征提取器学习域不变特征，通过域对抗机制减少分布偏移”，完美匹配问题中“保留共性、减少差异”的要求。

#### 二、算法工作原理
DANN由**特征提取器\( G \)**、**标签分类器\( C \)**、**域分类器\( D \)**、**梯度反转层（GRL）**四个组件组成，各组件的工作原理如下：
1. **特征提取器\( G \)**：将输入特征映射到高维空间，学习同时适用于源域与目标域的域不变特征。其优化目标是“最小化分类损失+最大化域分类损失”（通过GRL反转梯度）。
2. **标签分类器\( C \)**：利用源域标签监督特征提取器学习对故障判别有用的特征，优化目标是“最小化分类损失”。
3. **域分类器\( D \)**：判别特征的域归属，为特征提取器提供对抗目标，优化目标是“最小化域分类损失”。
4. **梯度反转层（GRL）**：连接特征提取器与域分类器，前向传播时恒等映射，反向传播时反转梯度，让特征提取器的优化目标与域分类器相反，强制学习域不变特征。

#### 三、核心算法公式
DANN的核心算法公式已在数学模型中详细推导，以下是关键公式的总结：
- **特征提取**：\( z = G(x) = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x + b_1) + b_2) \)
- **标签分类**：\( p = C(z) = \text{Softmax}(W_c z + b_c) \)
- **域分类**：\( q = D(\text{GRL}(z)) = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} z + b_{d1}) + b_{d2}) \)
- **总损失**：\( L_{\text{total}} = L_{\text{cls}} + L_{\text{dom}} \)
- **梯度计算**：\(
  abla_G L_{\text{total}} =
  abla_G L_{\text{cls}} - \lambda
  abla_G L_{\text{dom}} \)

### 问题三的模型求解步骤

求解步骤严格对应数学模型，每个步骤均用“公式+描述”的形式呈现，确保连贯性与可操作性：

#### 第一步：输入准备与参数初始化
**输入数据**：
- 源域特征数据集：`Source_Features.csv`（\( X_s \)、\( y_s \)）；
- 目标域数据集：16个`.mat`文件（\( \mathcal{T} = \{t_1,...,t_{16}\} \)）；
- 辅助表格：`bearing_geometry_params.csv`（轴承几何参数）、`fault_frequency_formula.csv`（故障频率公式）。

**参数初始化**：
- 模型结构参数：特征提取器\( G \)（13→64→64，ReLU）、标签分类器\( C \)（64→4，Softmax）、域分类器\( D \)（64→32→1，Sigmoid）；
- 超参数：学习率\( lr=0.001 \)、迭代次数\( epochs=100 \)、批次大小\( batch_size=32 \)、域对抗系数\( \lambda = \text{current_epoch} / 100 \)、随机种子\( random_state=42 \)。

#### 第二步：目标域特征提取与标准化
**目标**：将目标域时域信号转换为13维特征，并消除尺度差异。
1. **时域特征计算**：对每个目标域样本\( t_j \)，用以下公式计算时域特征：\[
   \text{Peak}*j = \max(t_j^{\text{acc}}), \quad \text{RMS}*j = \sqrt{\frac{1}{N}\sum*{k=1}^N a*{j,k}^2}, \quad \text{CrestFactor}_j = \frac{\text{Peak}_j}{\text{RMS}*j}, \quad \text{ImpulseFactor}*j = \frac{\text{Peak}*j}{\frac{1}{N}\sum*{k=1}^N |a*{j,k}|}, \quad \text{Kurtosis}*j = \frac{\frac{1}{N}\sum*{k=1}^N (a*{j,k} - \mu_j)^4}{(\sigma_j)^2}
   \]
2. **频域特征计算**：
   - 计算转速频率：\( t_j^{\text{fr}} = t_j^{\text{rpm}} / 60 \)；
   - 查询几何参数：\( t_j^{\text{n}}, t_j^{\text{d}}, t_j^{\text{D}} \)（由\( t_j^{\text{bt}} \)从`bearing_geometry_params.csv`获取）；
   - 计算理论故障频率：\( \text{BPFO}_j, \text{BPFI}_j, \text{BSF}_j \)（公式见数学模型）；
   - 提取频谱幅值：对\( t_j^{\text{acc}} \)做FFT，取理论频率±5%范围内的最大幅值作为\( \text{Amp_BPFO}_j, \text{Amp_BPFI}_j, \text{Amp_BSF}_j \)。
3. **时频特征计算**：用db4小波对\( t_j^{\text{acc}} \)做2层分解，计算4个节点的能量占比（公式见数学模型）。
4. **特征标准化**：用源域特征的均值\( \mu_{s,f} \)与标准差\( \sigma_{s,f} \)对目标域特征矩阵\( X_t \)标准化：\[
   X_{t,\text{scaled}}[j,f] = \frac{X_t[j,f] - \mu_{s,f}}{\sigma_{s,f}}
   \]

#### 第三步：DANN模型构建
**目标**：构建DANN的网络结构，明确各组件的连接关系。
1. **特征提取器\( G \)**：输入13维特征，输出64维域不变特征，前向传播公式：\[
   z = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x + b_1) + b_2)
   \]
2. **标签分类器\( C \)**：输入域不变特征，输出4类故障概率，前向传播公式：\[
   p = \text{Softmax}(W_c z + b_c)
   \]
3. **域分类器\( D \)与GRL**：输入域不变特征（经GRL），输出域归属概率，前向传播公式：\[
   q = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} \cdot \text{GRL}(z) + b_{d1}) + b_{d2})
   \]

#### 第四步：DANN联合训练
**目标**：通过双任务优化模型参数。
1. **数据加载与批次生成**：
   - 加载源域特征矩阵\( X_s \)、源域标签向量\( y_s \)；
   - 加载目标域标准化特征矩阵\( X_{t,\text{scaled}} \)；
   - 对源域数据随机打乱，按\( batch_size=32 \)生成mini-batch；对目标域数据按同样批次大小生成mini-batch（不足时重复采样）。
2. **前向传播**：
   - 对源域mini-batch\( \{x_s^b, y_s^b\} \)：计算域不变特征\( z_s^b = G(x_s^b) \)、分类概率\( p_s^b = C(z_s^b) \)、域概率\( q_s^b = D(\text{GRL}(z_s^b)) \)；
   - 对目标域mini-batch\( \{x_t^b\} \)：计算域不变特征\( z_t^b = G(x_t^b) \)、域概率\( q_t^b = D(\text{GRL}(z_t^b)) \)。
3. **损失计算**：
   - 标签分类损失：\( L_{\text{cls}} = -\frac{1}{|B_s|} \sum_{i \in B_s} \sum_{k=0}^3 y_{s,i,k} \log(p_{s,i,k}) \)（\( |B_s| \)为源域mini-batch大小）；
   - 域分类损失：\( L_{\text{dom}} = -\frac{1}{|B_s| + |B_t|} \left( \sum_{i \in B_s} \log(q_{s,i}) + \sum_{j \in B_t} \log(1 - q_{t,j}) \right) \)（\( |B_t| \)为目标域mini-batch大小）；
   - 总损失：\( L_{\text{total}} = L_{\text{cls}} + L_{\text{dom}} \)。
4. **梯度计算与参数更新**：
   - 标签分类器\( C \)：\(
     abla_C L_{\text{total}} =
     abla_C L_{\text{cls}} \)，用Adam优化器更新参数；
   - 域分类器\( D \)：\(
     abla_D L_{\text{total}} =
     abla_D L_{\text{dom}} \)，用Adam优化器更新参数；
   - 特征提取器\( G \)：\(
     abla_G L_{\text{total}} =
     abla_G L_{\text{cls}} - \lambda
     abla_G L_{\text{dom}} \)，用Adam优化器更新参数。
5. **迭代训练**：重复上述步骤100次，每轮迭代更新\( \lambda = \text{current_epoch} / 100 \)。

#### 第五步：目标域分类标定
**目标**：用训练好的模型预测目标域样本的故障类型。
1. **特征投影**：将目标域标准化特征矩阵\( X_{t,\text{scaled}} \)输入特征提取器\( G \)，得到域不变特征矩阵\( Z_t = G(X_{t,\text{scaled}}) \)；
2. **故障类型预测**：将\( Z_t \)输入标签分类器\( C \)，得到预测概率矩阵\( P_t = C(Z_t) \)；对每个样本\( j \)，用以下公式取概率最大的类别作为预测标签：\[
   y_{t,j} = \arg\max_{k \in \{0,1,2,3\}} P_{t,j,k}
   \]

#### 第六步：输出结果
**输出内容**：
1. 目标域特征矩阵\( X_t \)（16×13）；
2. 训练好的DANN模型参数（\( G \)、\( C \)、\( D \)的权重与偏置）；
3. 目标域分类结果\( y_t \)（16×1）；
4. 迁移结果可视化（损失曲线、PCA散点图、置信度分布）。
