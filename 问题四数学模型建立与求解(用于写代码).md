### 问题四的数学模型建立

#### 一、问题四所需的数据文件与变量
1. **数据文件**：
   - **源域特征数据集文件**：`Source_Features.csv`，包含161个样本（对应公式中源域样本数161），每个样本含13维特征（时域4个：`Peak`/`RMS`/`CrestFactor`/`ImpulseFactor`/`Kurtosis`？不，原始字段是13维：`Peak`（1）、`RMS`（2）、`CrestFactor`（3）、`ImpulseFactor`（4）、`Kurtosis`（5）、`Amp_BPFO`（6）、`Amp_BPFI`（7）、`Amp_BSF`（8）、`Energy_WP1`-`Energy_WP4`（9-12）？不对，原始字段是13维：`SampleID`（非特征）、13个特征（`Peak`到`Energy_WP4`共13个）、`Label`。业务含义：覆盖轴承故障的**时域冲击特征**（如`Peak`反映冲击强度）、**频域特征频率幅值**（如`Amp_BPFI`反映内圈故障频率的能量）、**时频域能量分布**（如`Energy_WP1`反映小波包分解后的能量占比）。
   - **目标域特征矩阵**：\( X_t \in \mathbb{R}^{16 \times 13} \)，由问题三输出（16个目标域样本，13维特征，无标签），业务含义：需诊断的跨工况/跨设备轴承样本特征。
   - **轴承几何参数文件**：`bearing_geometry_params.csv`，含滚动体数\( n \)、滚动体直径\( d \)（英寸）、轴承节径\( D \)（英寸），物理含义：用于计算轴承故障特征频率（如\( \text{BPFI} = f_r \cdot \frac{n}{2} \cdot (1 + \frac{d}{D}) \)）。
   - **故障频率公式文件**：`fault_frequency_formula.csv`，含故障名称与特征频率公式，业务含义：关联轴承几何参数与故障类型的核心机理（如内圈故障对应`BPFI`公式）。

2. **模型变量**：
   - 特征提取器\( G \)：\( G: \mathbb{R}^{13} \to \mathbb{R}^{64} \)，输入13维多域特征，输出64维**域不变特征**（去除转速、负载等域相关信息，保留故障特征频率、冲击强度等域不变信息）。结构为“全连接层1（13→64，ReLU）→全连接层2（64→64，ReLU）”，ReLU激活的物理含义：引入非线性，拟合多域特征间的复杂非线性关系（轴承故障特征的多域分布是非线性的）。
   - 标签分类器\( C \)：\( C: \mathbb{R}^{64} \to \mathbb{R}^4 \)，输入域不变特征，输出4类故障概率（0=正常、1=内圈、2=外圈、3=滚动体）。结构为“全连接层（64→4，Softmax）”，Softmax的业务含义：输出故障类型的概率分布，符合诊断人员“基于概率判断故障”的流程。
   - 域分类器\( D \)：\( D: \mathbb{R}^{64} \to [0,1] \)，输入域不变特征，输出样本属于**源域**的概率（\( 1-D(z) \)为属于目标域的概率）。结构为“全连接层1（64→32，ReLU）→全连接层2（32→1，Sigmoid）”，Sigmoid的物理含义：将域判别结果映射到0-1概率区间。

3. **迁移过程变量**：
   - 分类损失\( L_{\text{cls}} \)：源域故障分类的交叉熵损失，衡量\( G \)和\( C \)对源域故障的识别能力。
   - 域损失\( L_{\text{dom}} \)：域分类的交叉熵损失，衡量\( D \)对源域/目标域的判别能力。
   - 总损失\( L_{\text{total}} \)：分类损失与域损失的加权和，权重\( \lambda = \frac{\text{current_epoch}}{100} \)（线性递增，从0到1），物理含义：初始阶段侧重学习源域分类（\( \lambda \)小），后期侧重学习域不变特征（\( \lambda \)大）。
   - 特征提取器梯度\(
     abla_G L_{\text{total}} \)：\( G \)的优化方向，结合分类损失的“最小化”与域损失的“最大化”（梯度反转）。

4. **决策过程变量**：目标域预测标签\( y_{t,j} = \arg\max_k C(G(x_{t,j}))_k \)，业务含义：目标域第\( j \)个样本的故障类型（取概率最大的类别）。

5. **轴承故障机理变量**：
   - 转速频率\( f_r = \frac{\text{rpm}}{60} \)（单位：Hz），物理含义：轴承内圈旋转频率（源域与目标域可能不同，属于域相关信息）。
   - 故障特征频率：内圈故障\( \text{BPFI} = f_r \cdot \frac{n}{2} \cdot (1 + \frac{d}{D}) \)、外圈故障\( \text{BPFO} = f_r \cdot \frac{n}{2} \cdot (1 - \frac{d}{D}) \)、滚动体故障\( \text{BSF} = f_r \cdot \frac{D}{d} \cdot (1 - (\frac{d}{D})^2) \)，物理含义：轴承故障的核心特征（不同故障类型对应唯一特征频率）。

#### 二、问题四的参数设置
1. **可解释性分析维度**：
   - **事前解释**：模型结构与故障机理的一致性，参数依据：轴承故障特征分布在时域（冲击）、频域（特征频率）、时频域（能量），故\( G \)需融合多域特征；\( C \)需输出4类概率（对应4种故障类型）；\( D \)需判别域归属（倒逼\( G \)学习域不变特征）。
   - **迁移过程解释**：域损失变化曲线的迭代次数设为100次（因\( \lambda = \frac{\text{current_epoch}}{100} \)，100次迭代后\( \lambda = 1 \)），参数依据：平衡分类与域对齐的训练阶段。
   - **事后解释**：SHAP值的期望计算依据**条件期望与边际期望的差**，参数依据：SHAP值的公理（局部准确性、缺失性、一致性），确保特征重要性解释的合理性。

2. **分析方法**：
   - 事前解释：结合多域特征的物理含义（如`Peak`→冲击强度），说明\( G \)的层结构为何能融合多域特征（全连接层的线性变换+ReLU的非线性）。
   - 迁移过程解释：绘制\( L_{\text{dom}} \)随迭代次数的变化，参数依据：\( L_{\text{dom}} \)的减小对应\( D \)判别能力的下降（\( G \)学习到域不变特征）。
   - 事后解释：SHAP值的计算依据**模型无关的可解释性方法**，参数依据：目标域样本无标签，需通过特征贡献度解释决策。

#### 三、问题四的约束条件
1. **机理一致性约束**：解释内容必须关联轴承故障特征频率公式，数学表达为：对任意目标域内圈故障样本\( j \)，其\( \text{Amp_BPFI} \)特征的SHAP值需满足：\[ \phi_{\text{Amp_BPFI}}(j) > 0 \quad \text{且} \quad \phi_{\text{Amp_BPFI}}(j) = \max_{f \in \text{特征集}} \phi_f(j) \]物理含义：内圈故障的核心特征是\( \text{BPFI} \)频率幅值升高，故该特征对决策的贡献最大且为正（正贡献表示特征值增大时内圈故障概率升高）。同理，外圈故障需满足\( \phi_{\text{Amp_BPFO}}(j) \)最大且为正，滚动体故障需满足\( \phi_{\text{Amp_BSF}}(j) \)最大且为正。

2. **模型对应约束**：解释内容必须对应DANN的组件，数学表达为：对任意源域同类故障样本\( x_{s,i1}, x_{s,i2} \)（属于第\( k \)类）与目标域同类故障样本\( x_{t,j} \)，特征提取器输出需满足：\[ \| G(x_{s,i1}) - G(x_{t,j}) \|*2 < \frac{1}{|S_k|} \sum*{x_s \in S_k} \| G(x_s) - \mu_k \|*2 \]其中\( S_k \)是源域第\( k \)类故障样本集，\( \mu_k = \frac{1}{|S_k|} \sum*{x_s \in S_k} G(x_s) \)是源域第\( k \)类特征均值，\( \| \cdot \|_2 \)是欧氏距离。物理含义：跨域同类故障的特征差异小于源域内同类故障的特征差异（\( G \)提取的特征是域不变的）。

3. **可理解性约束**：解释内容必须使用轴承故障诊断的工程术语，数学表达为：解释内容\( E \)需满足\( E \in T \)，其中工程术语集合：\[ T = \{ \text{冲击强度（Peak）}, \text{特征频率幅值（Amp_BPFI/Amp_BPFO/Amp_BSF）}, \text{能量占比（Energy_WP1-WP4）}, \text{域不变特征（G(x)）}, \text{分类概率（C(z)_k）} \} \]物理含义：术语需与诊断人员的知识体系一致（如“特征频率幅值”比“频域特征1”更易理解）。

#### 四、问题四的完整数学模型公式
### 1. 事前可解释性分析（模型结构合理性）
事前可解释性的核心是**模型结构与轴承故障机理的一致性**，即模型组件的设计需直接对应故障诊断的物理逻辑。

#### （1）特征提取器\( G \)的合理性：多域特征融合与域不变特征学习
轴承故障的有效特征分布在**时域**（冲击强度，如`Peak`）、**频域**（特征频率幅值，如`Amp_BPFI`）、**时频域**（能量分布，如`Energy_WP1`），这些特征的非线性组合才能准确描述故障状态。\( G \)的结构设计需融合多域特征并去除域相关信息（如转速），其数学表达为：\[ G(x) = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x + b_1) + b_2) \]其中：
- \( x \in \mathbb{R}^{13} \)：输入的多域特征向量（来自源域或目标域）；
- \( W_1 \in \mathbb{R}^{64 \times 13} \)：第一层全连接层权重矩阵，维度依据：将13维多域特征映射到64维隐藏空间（平衡特征表达能力与计算复杂度），物理含义：融合时域、频域、时频域特征；
- \( b_1 \in \mathbb{R}^{64} \)：第一层偏置向量；
- \( W_2 \in \mathbb{R}^{64 \times 64} \)：第二层全连接层权重矩阵，维度依据：增强特征的域不变性（通过非线性变换去除转速等域相关信息）；
- \( b_2 \in \mathbb{R}^{64} \)：第二层偏置向量；
- \( \text{ReLU}(·) \)：整流线性单元激活函数，物理含义：引入非线性，拟合多域特征间的复杂关系（轴承故障特征的多域分布是非线性的）。

**合理性解释**：\( W_1 \)融合13维多域特征，\( W_2 \)通过非线性变换增强域不变性（如保留`Amp_BPFI`的幅值信息，去除转速对`Amp_BPFI`的影响），最终输出的\( G(x) \)是**域不变且故障相关的特征**（符合迁移学习的核心目标）。

#### （2）标签分类器\( C \)的合理性：故障概率输出与机理对应
轴承故障诊断的核心是**根据特征频率判断故障类型**（如`Amp_BPFI`高→内圈故障），\( C \)需将域不变特征映射到故障概率，其数学表达为：\[ C(z) = \text{Softmax}(W_c z + b_c) \]其中：
- \( z = G(x) \in \mathbb{R}^{64} \)：域不变特征向量；
- \( W_c \in \mathbb{R}^{4 \times 64} \)：全连接层权重矩阵，维度依据：将64维域不变特征映射到4类故障概率；
- \( b_c \in \mathbb{R}^4 \)：偏置向量；
- \( \text{Softmax}(·) \)： Softmax激活函数，数学定义：\( \text{Softmax}(a)*k = \frac{e^{a_k}}{\sum*{m=0}^3 e^{a_m}} \)，物理含义：输出故障类型的概率分布（\( C(z)_k \)表示样本属于第\( k \)类故障的概率）。

**合理性解释**：\( W_c \)的权重需与故障机理对应（如\( W_c \)的第1行（内圈故障）需对`Amp_BPFI`的域不变特征赋予高权重），Softmax输出的概率分布符合诊断人员“基于证据（特征）判断概率”的流程（如`Amp_BPFI`高→内圈故障概率高）。

#### （3）域分类器\( D \)的合理性：域差异判别与倒逼域不变特征
迁移学习的核心是**学习域不变特征**，即特征需同时满足“能区分故障类型”（对\( C \)有用）和“不能区分域归属”（对\( D \)无用）。\( D \)的设计需判别特征的域归属，其数学表达为：\[ D(z) = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} z + b_{d1}) + b_{d2}) \]其中：
- \( W_{d1} \in \mathbb{R}^{32 \times 64} \)：第一层全连接层权重矩阵，维度依据：将64维域不变特征映射到32维隐藏空间，提取域相关信息（如转速）；
- \( b_{d1} \in \mathbb{R}^{32} \)：第一层偏置向量；
- \( W_{d2} \in \mathbb{R}^{1 \times 32} \)：第二层全连接层权重矩阵，维度依据：将32维域相关特征映射到1维域概率；
- \( b_{d2} \in \mathbb{R}^1 \)：第二层偏置向量；
- \( \text{Sigmoid}(·) \)：Sigmoid激活函数，数学定义：\( \text{Sigmoid}(a) = \frac{1}{1 + e^{-a}} \)，物理含义：输出样本属于源域的概率（\( 1-D(z) \)为属于目标域的概率）。

**合理性解释**：\( D \)的目标是最大化域分类准确率（\( L_{\text{dom}} \)最小化），而\( G \)的目标是最小化\( D \)的准确率（通过梯度反转），这种对抗训练会倒逼\( G \)学习**域不变特征**（如`Amp_BPFI`的幅值与转速无关，\( D \)无法通过`Amp_BPFI`区分域归属）。

### 2. 迁移过程可解释性分析（域对抗训练作用）
迁移过程的可解释性核心是**域对抗训练如何让\( G \)学习域不变特征**，即通过损失函数的变化与梯度方向解释\( G \)的优化逻辑。

#### （1）分类损失：源域故障分类的准确性
分类损失衡量\( G \)和\( C \)对源域故障的识别能力，数学表达为：\[ L_{\text{cls}} = -\frac{1}{N_s} \sum_{i=1}^{N_s} \sum_{k=0}^3 y_{s,i,k} \log C(G(x_{s,i}))_k \]其中：
- \( N_s = 161 \)：源域样本数量（来自`Source_Features.csv`）；
- \( y_{s,i,k} \in \{0,1\} \)：源域第\( i \)个样本的第\( k \)类独热标签（若样本属于第\( k \)类则\( y_{s,i,k}=1 \)，否则为0），业务含义：故障类型的二进制指示；
- \( C(G(x_{s,i}))_k \)：源域第\( i \)个样本经\( G \)提取特征后，\( C \)输出的第\( k \)类故障概率。

**物理含义**：\( L_{\text{cls}} \)最小化表示\( G \)提取的特征能让\( C \)准确识别源域故障（如内圈故障样本的`Amp_BPFI`特征高→\( C \)输出内圈概率高）。

#### （2）域损失：域分类器的判别能力
域损失衡量\( D \)对源域/目标域的判别能力，数学表达为：\[ L_{\text{dom}} = -\frac{1}{N_s + N_t} \left( \sum_{i=1}^{N_s} \log D(G(x_{s,i})) + \sum_{j=1}^{N_t} \log(1 - D(G(x_{t,j}))) \right) \]其中：
- \( N_t = 16 \)：目标域样本数量（来自问题三输出的\( X_t \)）；
- \( D(G(x_{s,i})) \)：源域第\( i \)个样本属于源域的概率（\( D \)的输出）；
- \( 1 - D(G(x_{t,j})) \)：目标域第\( j \)个样本属于目标域的概率。

**物理含义**：\( L_{\text{dom}} \)最小化表示\( D \)能准确区分源域与目标域（如源域样本的`Peak`特征受转速影响→\( D \)能通过`Peak`判别域归属）。

#### （3）总损失：分类与域对齐的平衡
总损失是分类损失与域损失的加权和，数学表达为：\[ L_{\text{total}} = L_{\text{cls}} + \lambda L_{\text{dom}} \]其中权重：\[ \lambda = \frac{\text{current_epoch}}{E_{\text{total}}} \]
- \( \text{current_epoch} \)：当前训练迭代次数（1 ≤ current_epoch ≤ \( E_{\text{total}} \)）；
- \( E_{\text{total}} = 100 \)：总迭代次数（参数依据：确保\( \lambda \)从0线性递增到1）。

**物理含义**：\( \lambda \)的线性递增实现“先分类后域对齐”的训练策略：
- 初始阶段（current_epoch小，\( \lambda \)小）：侧重最小化\( L_{\text{cls}} \)，让\( G \)和\( C \)先学会识别源域故障；
- 后期阶段（current_epoch大，\( \lambda \)大）：侧重最大化\( L_{\text{dom}} \)（通过梯度反转），让\( G \)学习域不变特征。

#### （4）梯度反转：\( G \)的优化方向
特征提取器\( G \)的梯度由分类损失梯度与域损失梯度组成，数学表达为：\[
abla_G L_{\text{total}} =
abla_G L_{\text{cls}} - \lambda
abla_G L_{\text{dom}} \]其中域损失的梯度为：\[
abla_G L_{\text{dom}} = -\frac{1}{N_s + N_t} \left( \sum_{i=1}^{N_s} \frac{
abla_G D(G(x_{s,i}))}{D(G(x_{s,i}))} + \sum_{j=1}^{N_t} \frac{-
abla_G D(G(x_{t,j}))}{1 - D(G(x_{t,j}))} \right) \]

**物理含义**：
- \(
  abla_G L_{\text{cls}} \)：\( G \)的优化方向是**最小化**分类损失（提升源域分类准确率）；
- \( -\lambda
  abla_G L_{\text{dom}} \)：通过“负号”反转域损失梯度的方向，使\( G \)的优化方向变为**最大化**域损失（降低\( D \)的域分类准确率）。

**实例解释**：内圈故障样本\( x_{s,i} \)（源域）与\( x_{t,j} \)（目标域）的`Amp_BPFI`特征受转速影响（源域转速\( f_{r,s} \)≠目标域转速\( f_{r,t} \)），若\( G \)直接输出`Amp_BPFI`的原始幅值，则\( D \)可通过`Amp_BPFI`的大小区分域归属（\( f_{r,s} \)大→`Amp_BPFI`大→源域）。梯度反转后，\( G \)需调整`Amp_BPFI`的映射方式（如归一化），让\( D \)无法通过`Amp_BPFI`区分域归属，从而学习到**域不变的`Amp_BPFI`特征**（与转速无关，仅与内圈故障相关）。

### 3. 事后可解释性分析（目标域决策特征重要性）
事后可解释性的核心是**解释模型决策的依据**，即目标域样本的故障类型预测依赖哪些特征，这些特征是否符合轴承故障机理。

#### （1）SHAP值：特征重要性的量化
SHAP值（SHapley Additive exPlanations）是基于博弈论的特征重要性度量，衡量单个特征对预测结果的贡献。目标域第\( j \)个样本的第\( f \)个特征的SHAP值数学表达为：\[ \phi_f(j) = \mathbb{E}*{\mathbf{X}*{-f}} \left[ C(G(\mathbf{X}*t[j] \mid \mathbf{X}*t[j,f] = x*{t,j,f})) \right] - \mathbb{E}*{\mathbf{X}} \left[ C(G(\mathbf{X})) \right] \]其中：
- \( \phi_f(j) \)：目标域第\( j \)个样本的第\( f \)个特征的SHAP值，业务含义：该特征对预测结果的贡献度（正贡献表示特征值增大时预测概率升高，负贡献反之）；
- \( \mathbf{X}*{-f} \)：去除第\( f \)个特征后的特征集（12维），即\( \mathbf{X}*{-f} = \{ \text{特征1}, ..., \text{特征}f-1, \text{特征}f+1, ..., \text{特征13} \} \)；
- \( \mathbf{X}*t[j] \mid \mathbf{X}*t[j,f] = x*{t,j,f} \)：目标域第\( j \)个样本固定第\( f \)个特征为其实际值\( x*{t,j,f} \)，其余特征来自\( \mathbf{X}_{-f} \)的边际分布（即其余特征的取值与第\( f \)个特征无关）；
- \( \mathbb{E}*{\mathbf{X}*{-f}} [·] \)：对\( \mathbf{X}*{-f} \)取期望，计算固定\( x*{t,j,f} \)时的平均预测概率；
- \( \mathbb{E}_{\mathbf{X}} [C(G(\mathbf{X}))] \)：所有特征取边际分布时的平均预测概率（基准值，即不考虑任何特征时的预测概率）。

**物理含义**：\( \phi_f(j) \)是“固定第\( f \)个特征为实际值”的预测概率与“不考虑任何特征”的预测概率之差，差值越大表示该特征对决策的贡献越大。

#### （2）机理关联：SHAP值与故障机理的一致性
根据轴承故障机理，不同故障类型的决策应依赖对应的特征频率幅值，SHAP值需满足：

##### 内圈故障样本（预测标签\( y_{t,j}=1 \)）
内圈故障的核心特征是**\( \text{BPFI} \)频率的幅值升高**（机理公式：\( \text{BPFI} = f_r \cdot \frac{n}{2} \cdot (1 + \frac{d}{D}) \)），故SHAP值需满足：\[ \phi_{\text{Amp_BPFI}}(j) > 0 \quad \text{且} \quad \phi_{\text{Amp_BPFI}}(j) = \max_{f=1}^{13} \phi_f(j) \]物理含义：\( \text{Amp_BPFI} \)是内圈故障决策的**关键特征**（正贡献表示特征值越大，内圈故障概率越高；最大表示该特征的贡献超过其他所有特征）。

##### 外圈故障样本（预测标签\( y_{t,j}=2 \)）
外圈故障的核心特征是**\( \text{BPFO} \)频率的幅值升高**（机理公式：\( \text{BPFO} = f_r \cdot \frac{n}{2} \cdot (1 - \frac{d}{D}) \)），故SHAP值需满足：\[ \phi_{\text{Amp_BPFO}}(j) > 0 \quad \text{且} \quad \phi_{\text{Amp_BPFO}}(j) = \max_{f=1}^{13} \phi_f(j) \]

##### 滚动体故障样本（预测标签\( y_{t,j}=3 \)）
滚动体故障的核心特征是**\( \text{BSF} \)频率的幅值升高**（机理公式：\( \text{BSF} = f_r \cdot \frac{D}{d} \cdot (1 - (\frac{d}{D})^2) \)），故SHAP值需满足：\[ \phi_{\text{Amp_BSF}}(j) > 0 \quad \text{且} \quad \phi_{\text{Amp_BSF}}(j) = \max_{f=1}^{13} \phi_f(j) \]

##### 正常样本（预测标签\( y_{t,j}=0 \)）
正常状态的核心特征是**无冲击**（时域峭度\( \text{Kurtosis} \)接近0），故SHAP值需满足：\[ |\phi_{\text{Kurtosis}}(j)| = \min_{f=1}^{13} |\phi_f(j)| \]物理含义：\( \text{Kurtosis} \)对正常样本决策的贡献最小（正常信号无冲击，峭度无法区分正常与故障）。

### 3. 事后可解释性的可视化：SHAP Summary Plot
SHAP Summary Plot是事后可解释性的关键可视化工具，用于展示所有目标域样本的特征重要性。其数学表达对应SHAP值的分布：
- **横坐标**：SHAP值\( \phi_f(j) \)（特征对预测的贡献）；
- **纵坐标**：特征名称（使用工程术语，如`Amp_BPFI`、`Kurtosis`）；
- **颜色**：特征值大小（红色表示特征值大，蓝色表示特征值小）。

**实例解释**：内圈故障样本的`Amp_BPFI`特征SHAP值集中在**正值区域**（正贡献），且颜色偏**红色**（特征值大），说明：
1. `Amp_BPFI`值越大，内圈故障的预测概率越高（正贡献，符合机理）；
2. 内圈故障样本的`Amp_BPFI`值普遍较大（红色，符合机理：内圈故障时`Amp_BPFI`幅值升高）；
3. `Amp_BPFI`的SHAP值分布范围比其他特征广（贡献最大，符合机理一致性约束）。

### 五、可解释性可视化模型
可视化是可解释性的直观表达，需直接对应数学模型的逻辑：

#### 1. 域对抗损失曲线：域分类能力的下降
域对抗损失随迭代次数的变化曲线数学表达为：\[ L_{\text{dom}}(\text{epoch}) = f(\text{epoch}) \]其中\( f(\text{epoch}) \)是**单调递减函数**，且满足：\[ \lim_{\text{epoch} \to E_{\text{total}}} f(\text{epoch}) = -\log 0.5 \approx 0.693 \]

**物理含义**：
- 单调递减：随着迭代次数增加，\( G \)学习到更多域不变特征，\( D \)的域分类准确率下降（\( L_{\text{dom}} \)减小）；
- 极限值：当\( D \)完全无法区分源域与目标域时，域分类概率为0.5（随机猜测），此时域损失为\( -\log 0.5 \)（交叉熵损失的最小值）。

**可视化含义**：曲线从初始值（约0.7）逐渐下降到0.693，说明域对抗训练有效（\( G \)学习到域不变特征）。

#### 2. 特征对齐散点图：域不变特征的跨域一致性
特征对齐散点图将域不变特征\( G(x) \)通过PCA（主成分分析）降维到二维空间，数学表达为：\[ \text{PCA}(G(x)) = U^T (G(x) - \mu_G) \]其中：
- \( U \in \mathbb{R}^{64 \times 2} \)：PCA的前两个主成分（方差最大的方向）；
- \( \mu_G = \frac{1}{N_s + N_t} \sum_{x \in X_s \cup X_t} G(x) \)：所有样本的域不变特征均值。

**物理含义**：
- 源域样本用蓝色点表示，目标域样本用红色点表示；
- 同类故障的蓝红点数应**聚集在一起**（欧氏距离小），说明\( G \)学习到的域不变特征让跨域同类故障分布一致（符合模型对应约束）。

**实例解释**：内圈故障的源域蓝色点与目标域红色点聚集在同一区域，说明\( G \)提取的`Amp_BPFI`特征与转速无关（域不变），跨域内圈故障的特征分布一致（符合机理）。

### 总结
问题四的数学模型通过**事前结构合理性**（模型组件对应故障机理）、**迁移过程可解释性**（域对抗训练的梯度逻辑）、**事后特征重要性**（SHAP值关联故障机理），完整解决了DANN模型的“黑箱”问题。每个公式与可视化都严格对应轴承故障的物理机制（如特征频率、冲击强度）与工程术语，确保诊断人员能**理解模型如何提取特征**、**如何跨域迁移**、**如何做出决策**，最终提升对模型的信任度。
### 问题四模型求解算法介绍
问题四的核心是**DANN模型的可解释性分析**，需从**事前结构合理性**、**迁移过程有效性**、**事后决策依据**三个维度展开。选用的求解算法需紧密关联轴承故障机理与模型逻辑，具体如下：

#### 1. 事前可解释性分析（模型结构与机理关联）
- **算法原理**：结合轴承故障的物理机理（内圈故障对应`BPFI`特征频率、外圈故障对应`BPFO`特征频率、滚动体故障对应`BSF`特征频率），逐一验证DANN各组件的设计与机理的一致性。特征提取器\(G\)通过全连接层融合时域（冲击）、频域（特征频率幅值）、时频域（能量分布）特征，并用ReLU引入非线性以拟合多域特征的复杂关系；标签分类器\(C\)通过Softmax输出故障概率，符合诊断人员“基于证据判断概率”的逻辑；域分类器\(D\)通过对抗训练倒逼\(G\)学习域不变特征（如`Amp_BPFI`的幅值与转速无关）。
- **适配性**：直接对应数学模型中“模型结构与故障机理一致性”的核心要求，确保模型组件设计不脱离物理逻辑。

#### 2. 迁移过程可解释性分析（域对抗损失曲线可视化）
- **算法原理**：通过迭代训练（总迭代次数\(E_{\text{total}}=100\)），计算每轮迭代的域对抗损失\(L_{\text{dom}}\)（衡量域分类器\(D\)的判别能力），并绘制其随迭代次数的变化曲线。曲线单调递减表示\(G\)学习到的域不变特征逐渐增多，\(D\)无法区分源域与目标域。
- **适配性**：对应数学模型中“迁移过程约束”（\(L_{\text{dom}}\)的最小化与梯度反转），直观展示域差异的减小过程。

#### 3. 事后可解释性分析（SHAP值）
- **算法原理**：使用SHAP值量化目标域样本的特征贡献，其本质是“固定某特征为实际值的条件期望”与“不考虑任何特征的边际期望”的差值。通过验证SHAP值与故障机理的一致性（如内圈故障样本的`Amp_BPFI`特征SHAP值最大且为正），解释模型决策的依据。
- **适配性**：对应数学模型中“事后特征重要性”的要求，确保特征贡献符合轴承故障机理。

#### 4. 特征对齐可视化（PCA降维）
- **算法原理**：用PCA将\(G\)输出的64维域不变特征降维到2维，绘制源域（蓝色）与目标域（红色）样本的散点图。同类故障样本的重叠程度越高，说明\(G\)学习到的域不变特征越有效。
- **适配性**：对应数学模型中“跨域同类故障特征差异约束”，直观展示域不变特征的对齐效果。

### 问题四模型求解详细步骤

#### 步骤1：输入数据与变量的精准定义与预处理
**输入数据文件与变量映射**：
1. **源域特征数据集**（`Source_Features.csv`）：包含161个样本，字段为`SampleID`（非特征）、13个特征（`Peak`（时域冲击强度）、`RMS`（时域均方根）、`CrestFactor`（时域波峰因子）、`ImpulseFactor`（时域脉冲因子）、`Kurtosis`（时域峭度）、`Amp_BPFO`（外圈故障频率幅值）、`Amp_BPFI`（内圈故障频率幅值）、`Amp_BSF`（滚动体故障频率幅值）、`Energy_WP1`-`Energy_WP4`（时频域小波包能量占比））、`Label`（故障类型标签：0=正常、1=内圈、2=外圈、3=滚动体）。预处理时去除`SampleID`，保留13个特征与`Label`。
2. **目标域特征矩阵**（\(X_t \in \mathbb{R}^{16 \times 13}\)）：由问题三输出，包含16个无标签样本，特征维度与源域一致。
3. **轴承几何参数文件**（`bearing_geometry_params.csv`）：字段为滚动体数\(n\)、滚动体直径\(d\)（英寸）、轴承节径\(D\)（英寸），用于计算故障特征频率（如\(\text{BPFI} = f_r \cdot \frac{n}{2} \cdot (1 + \frac{d}{D})\)）。
4. **故障频率公式文件**（`fault_frequency_formula.csv`）：字段为故障名称（内圈、外圈、滚动体）与对应特征频率公式，关联几何参数与故障类型。

**模型结构变量定义**：
- 特征提取器\(G\)：输入13维特征，输出64维域不变特征，结构为“全连接层1（13→64，权重\(W_1 \in \mathbb{R}^{64 \times 13}\)，偏置\(b_1 \in \mathbb{R}^{64}\)，ReLU激活）→全连接层2（64→64，权重\(W_2 \in \mathbb{R}^{64 \times 64}\)，偏置\(b_2 \in \mathbb{R}^{64}\)，ReLU激活）”，数学表达为\(G(x) = \text{ReLU}(W_2 \cdot \text{ReLU}(W_1 x + b_1) + b_2)\)。
- 标签分类器\(C\)：输入64维域不变特征，输出4类故障概率，结构为“全连接层（64→4，权重\(W_c \in \mathbb{R}^{4 \times 64}\)，偏置\(b_c \in \mathbb{R}^4\)，Softmax激活）”，数学表达为\(C(z) = \text{Softmax}(W_c z + b_c)\)。
- 域分类器\(D\)：输入64维域不变特征，输出源域概率，结构为“全连接层1（64→32，权重\(W_{d1} \in \mathbb{R}^{32 \times 64}\)，偏置\(b_{d1} \in \mathbb{R}^{32}\)，ReLU激活）→全连接层2（32→1，权重\(W_{d2} \in \mathbb{R}^{1 \times 32}\)，偏置\(b_{d2} \in \mathbb{R}^1\)，Sigmoid激活）”，数学表达为\(D(z) = \text{Sigmoid}(W_{d2} \cdot \text{ReLU}(W_{d1} z + b_{d1}) + b_{d2})\)。

**迁移过程变量定义**：
- 分类损失\(L_{\text{cls}}\)：源域故障分类的交叉熵损失，数学表达为\(L_{\text{cls}} = -\frac{1}{161} \sum_{i=1}^{161} \sum_{k=0}^3 y_{s,i,k} \log C(G(x_{s,i}))*k\)，其中\(y*{s,i,k}\)为源域第\(i\)个样本的第\(k\)类独热标签。
- 域损失\(L_{\text{dom}}\)：域分类的交叉熵损失，数学表达为\(L_{\text{dom}} = -\frac{1}{161+16} \left( \sum_{i=1}^{161} \log D(G(x_{s,i})) + \sum_{j=1}^{16} \log(1 - D(G(x_{t,j}))) \right)\)，其中源域样本的域标签为1，目标域为0。
- 总损失\(L_{\text{total}}\)：分类损失与域损失的加权和，数学表达为\(L_{\text{total}} = L_{\text{cls}} + \lambda L_{\text{dom}}\)，权重\(\lambda = \frac{\text{current_epoch}}{100}\)（\(\text{current_epoch}\)为当前迭代次数，范围1到100）。
- 梯度反转：特征提取器\(G\)的梯度为\(
  abla_G L_{\text{total}} =
  abla_G L_{\text{cls}} - \lambda
  abla_G L_{\text{dom}}\)，其中域损失梯度为\(
  abla_G L_{\text{dom}} = -\frac{1}{177} \left( \sum_{i=1}^{161} \frac{
  abla_G D(G(x_{s,i}))}{D(G(x_{s,i}))} + \sum_{j=1}^{16} \frac{-
  abla_G D(G(x_{t,j}))}{1 - D(G(x_{t,j}))} \right)\)。

**决策过程变量定义**：目标域第\(j\)个样本的预测标签为\(y_{t,j} = \arg\max_k C(G(x_{t,j}))_k\)（取概率最大的故障类型）。

**轴承故障机理变量定义**：
- 转速频率\(f_r = \frac{\text{rpm}}{60}\)（\(\text{rpm}\)为轴承转速，单位Hz）。
- 故障特征频率：内圈故障\(\text{BPFI} = f_r \cdot \frac{n}{2} \cdot (1 + \frac{d}{D})\)、外圈故障\(\text{BPFO} = f_r \cdot \frac{n}{2} \cdot (1 - \frac{d}{D})\)、滚动体故障\(\text{BSF} = f_r \cdot \frac{D}{d} \cdot (1 - (\frac{d}{D})^2)\)。

#### 步骤2：事前可解释性分析（模型结构与机理的一致性验证）
1. **特征提取器\(G\)的合理性验证**：
   - 全连接层1（\(W_1\)）：将13维多域特征映射到64维，融合时域（`Peak`）、频域（`Amp_BPFI`）、时频域（`Energy_WP1`）特征，维度依据为“平衡特征表达能力与计算复杂度”。
   - ReLU激活：引入非线性，拟合多域特征间的复杂关系（如`Peak`与`Amp_BPFI`的非线性关联）。
   - 全连接层2（\(W_2\)）：通过非线性变换增强域不变性（如保留`Amp_BPFI`的幅值信息，去除转速对其的影响），最终输出域不变特征\(G(x)\)。

2. **标签分类器\(C\)的合理性验证**：
   - 全连接层（\(W_c\)）：将64维域不变特征映射到4类故障概率，权重\(W_c\)的第1行（内圈故障）需对`Amp_BPFI`的域不变特征赋予高权重，以关联内圈故障的机理。
   - Softmax激活：将输出转为概率分布（\(C(z)_k\)表示样本属于第\(k\)类的概率），符合诊断人员“基于证据判断概率”的逻辑。

3. **域分类器\(D\)的合理性验证**：
   - 全连接层1（\(W_{d1}\)）：从64维域不变特征中提取域相关信息（如转速），映射到32维隐藏空间。
   - 全连接层2（\(W_{d2}\)）：将32维域相关特征映射到1维，并用Sigmoid转为0-1概率（表示样本属于源域的概率）。
   - 对抗训练逻辑：\(D\)的目标是最小化\(L_{\text{dom}}\)（提升域判别能力），而\(G\)的目标是通过梯度反转最大化\(L_{\text{dom}}\)（降低\(D\)的判别能力），倒逼\(G\)学习域不变特征。

#### 步骤3：迁移过程可解释性分析（域对抗训练的迭代逻辑）
设置总迭代次数\(E_{\text{total}}=100\)（确保\(\lambda\)从0线性递增到1），按以下步骤迭代：
1. **计算权重\(\lambda\)**：对于当前迭代次数\(\text{current_epoch}\)（1≤\(\text{current_epoch}\)≤100），计算\(\lambda = \frac{\text{current_epoch}}{100}\)。
2. **优化分类损失**：
   - 前向传播源域样本\(x_{s,i}\)（\(i=1\)到161），得到\(G(x_{s,i})\)与\(C(G(x_{s,i}))\)。
   - 计算分类损失\(L_{\text{cls}}\)，并通过反向传播优化\(G\)与\(C\)的参数（最小化\(L_{\text{cls}}\)）。
3. **优化域损失**：
   - 前向传播源域样本\(x_{s,i}\)与目标域样本\(x_{t,j}\)（\(j=1\)到16），得到\(G(x_{s,i})\)、\(G(x_{t,j})\)、\(D(G(x_{s,i}))\)、\(D(G(x_{t,j}))\)。
   - 计算域损失\(L_{\text{dom}}\)，并通过反向传播优化\(D\)的参数（最小化\(L_{\text{dom}}\)）。
4. **梯度反转与优化\(G\)**：
   - 计算域损失的梯度\(
     abla_G L_{\text{dom}}\)，并反转其方向（乘以\(-\lambda\)）。
   - 计算总损失梯度\(
     abla_G L_{\text{total}} =
     abla_G L_{\text{cls}} - \lambda
     abla_G L_{\text{dom}}\)，通过反向传播优化\(G\)的参数（最小化\(L_{\text{total}}\)）。
5. **记录域损失**：提取当前迭代的\(L_{\text{dom}}\)值，用于后续曲线绘制。

迭代完成后，绘制\(L_{\text{dom}}(\text{epoch})\)随迭代次数的变化曲线，分析趋势：初始阶段\(L_{\text{dom}}\)较大（\(D\)能区分域），随迭代增加逐渐减小至\(-\log 0.5 \approx 0.693\)（\(D\)无法区分域）。

#### 步骤4：事后可解释性分析（SHAP值计算与机理验证）
1. **SHAP值计算**：
   - 使用`shap.DeepExplainer`加载DANN模型的\(G\)与\(C\)部分（需计算\(C(G(x))\)的输出），输入目标域特征矩阵\(X_t\)。
   - 对于目标域第\(j\)个样本（\(j=1\)到16）与第\(f\)个特征（\(f=1\)到13）：
     - 定义特征集\(\mathbf{X}_{-f}\)：去除第\(f\)个特征后的12维特征。
     - 计算条件期望\(\mathbb{E}*{\mathbf{X}*{-f}} \left[ C(G(\mathbf{X}*t[j] \mid \mathbf{X}*t[j,f] = x*{t,j,f})) \right]\)：固定第\(f\)个特征为\(x*{t,j,f}\)，其余特征从\(\mathbf{X}_{-f}\)的边际分布中采样，计算\(C(G(·))\)的均值。
     - 计算边际期望\(\mathbb{E}_{\mathbf{X}} \left[ C(G(\mathbf{X})) \right]\)：所有特征从边际分布中采样，计算\(C(G(·))\)的均值。
     - 计算SHAP值\(\phi_f(j) = \text{条件期望} - \text{边际期望}\)。

2. **机理一致性验证**：
   - 获取目标域样本的预测标签\(y_{t,j}\)（\(j=1\)到16）。
   - 对于内圈故障样本（\(y_{t,j}=1\)）：验证\(\phi_{\text{Amp_BPFI}}(j) > 0\)且为所有特征的最大SHAP值。
   - 对于外圈故障样本（\(y_{t,j}=2\)）：验证\(\phi_{\text{Amp_BPFO}}(j) > 0\)且为所有特征的最大SHAP值。
   - 对于滚动体故障样本（\(y_{t,j}=3\)）：验证\(\phi_{\text{Amp_BSF}}(j) > 0\)且为所有特征的最大SHAP值。
   - 对于正常样本（\(y_{t,j}=0\)）：验证\(|\phi_{\text{Kurtosis}}(j)| = \min_{f=1}^{13} |\phi_f(j)|\)。

#### 步骤5：可解释性可视化（模型逻辑的直观表达）
1. **特征提取器神经元激活图**：
   - 选取目标域内圈故障样本，计算\(G\)的输出层神经元对`Amp_BPFI`特征的梯度（反向传播）。
   - 梯度大的神经元对应`Amp_BPFI`特征，展示神经元与故障特征的关联。

2. **域对抗损失曲线**：
   - 横轴为迭代次数\(\text{epoch}\)（1到100），纵轴为域损失\(L_{\text{dom}}\)。
   - 标注初始值（\(\text{epoch}=1\)时的\(L_{\text{dom}}\)）、最小值（\(\text{epoch}=100\)时的\(L_{\text{dom}}≈0.693\)），展示曲线的单调递减趋势。

3. **SHAP Summary Plot**：
   - 横轴为SHAP值\(\phi_f(j)\)（特征对预测的贡献）。
   - 纵轴为特征名称（使用工程术语，如`Amp_BPFI`、`Kurtosis`）。
   - 颜色为特征值大小（红色表示特征值大，蓝色表示特征值小）。
   - 展示每个特征的SHAP值分布与特征值的相关性（如内圈故障样本的`Amp_BPFI`特征SHAP值集中在正值区域且颜色偏红）。

### 问题四模型求解输出内容
1. **事前可解释性分析结果**：特征提取器\(G\)的多域融合逻辑、标签分类器\(C\)的概率输出逻辑、域分类器\(D\)的对抗训练逻辑与轴承故障机理的一致性说明。
2. **迁移过程可解释性分析结果**：域对抗损失\(L_{\text{dom}}\)随迭代次数的变化曲线及趋势分析。
3. **事后可解释性分析结果**：目标域样本的SHAP值计算结果，及内圈、外圈、滚动体、正常样本的SHAP值与故障机理的一致性验证说明。
4. **可解释性可视化结果**：特征提取器神经元激活图、域对抗损失曲线、SHAP Summary Plot的可视化描述。
