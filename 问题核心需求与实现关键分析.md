### 问题一的核心需求与实现关键
#### 问题一的核心需求
从提供的161个源域数据中筛选满足条件的数据集；结合轴承故障机理（几何参数、特征频率），采用**EMD（经验模态分解）**方法对代表性源域数据进行时域、频域、时频特征分析；对整体数据集提取13维特征矩阵，并筛选有效特征用于后续诊断任务。

#### 问题一的实现关键
需严格匹配输入的约束条件，并融合EMD方法的核心公式：

##### 1. 数据筛选约束
源域样本需满足以下条件：
- 轴承类型：\( bt_i \in \{\text{SKF6205}, \text{SKF6203}\} \)；
- 故障类型：\( ft_i \in \{\text{Healthy}, \text{Outer_Race}, \text{Inner_Race}, \text{Ball}\} \)；
- 转速范围：\( \text{rpm}_i \in [1000, 3000] \)；
- 故障直径：\( fd_i \in \{0.007, 0.014, 0.021\} \)英寸。

##### 2. 轴承几何参数约束
滚动体数\( n_i \)、滚动体直径\( d_i \)、轴承节径\( D_i \)需严格匹配表1：\[
\begin{cases}
n_i=9, d_i=0.3126, D_i=1.537 & (bt_i=\text{SKF6205}) \\
n_i=9, d_i=0.2656, D_i=1.122 & (bt_i=\text{SKF6203})
\end{cases}
\]**作用**：保证故障特征频率计算的准确性（特征频率依赖几何参数）。

##### 3. 故障特征频率约束
基于表2的公式计算理论特征频率（用于频域特征验证）：
- 外圈故障（BPFO）：\( \text{BPFO}*i = f*{r,i} \cdot \frac{n_i}{2} \cdot \left(1 - \frac{d_i}{D_i}\right) \)；
- 内圈故障（BPFI）：\( \text{BPFI}*i = f*{r,i} \cdot \frac{n_i}{2} \cdot \left(1 + \frac{d_i}{D_i}\right) \)；
- 滚动体故障（BSF）：\( \text{BSF}*i = f*{r,i} \cdot \frac{D_i}{d_i} \left[ 1 - \left( \frac{d_i}{D_i} \right)^2 \right] \)。其中，\( f_{r,i} = \frac{\text{rpm}_i}{60} \)（转速转换为Hz）。**作用**：定位频域中故障对应的特征频率带，确保频域特征的物理意义。

##### 4. 特征提取约束（融合EMD方法）
特征提取需覆盖时域、频域、时频域，且满足输入的约束：
- **时域特征**：基于完整4秒时间序列\( a_i(t) \)计算：
  - 峰值：\( \text{Peak} = \max|a_i(t)| \)（反映冲击强度）；
  - 均方根：\( \text{RMS} = \sqrt{\frac{1}{4}\int_0^4 a_i(t)^2 dt} \)（反映信号能量）；
  - 峰值因子：\( \text{CrestFactor} = \frac{\text{Peak}}{\text{RMS}} \)（反映冲击的突变性）；
  - 脉冲因子：\( \text{ImpulseFactor} = \frac{\text{Peak}}{\frac{1}{4}\int_0^4 |a_i(t)| dt} \)（反映脉冲特性）；
  - 峭度：\( \text{Kurtosis} = \frac{1}{N}\sum_{i=1}^N \left( \frac{x_i - \mu}{\sigma} \right)^4 - 3 \)（\( \mu \)为均值，\( \sigma \)为标准差，反映信号的陡峭程度）。

- **频域特征**：
  - 特征频率幅值：对应理论频率±1Hz内的最大幅值，\( F_f = \max\{ |A_i(f)| \mid f \in [\text{FF}_i - 1, \text{FF}_i + 1] \} \)（\( A_i(f) \)是\( a_i(t) \)的FFT结果，\( \text{FF}_i \)为BPFO/BPFI/BSF）；
  - 谐波总能量：\( \sum_{k=1}^3 |A_i(k \cdot \text{FF}_i)| \)（反映特征频率的谐波强度）。

- **时频特征（EMD分解）**：EMD将非线性非平稳的振动信号\( a_i(t) \)分解为**固有模态函数（IMF）**和残差：\[ a_i(t) = \sum_{j=1}^n c_j(t) + r_n(t) \]其中，\( c_j(t) \)是第\( j \)个IMF（满足IMF的两个条件：极值点数量与过零点数量相等；上下包络的均值为0），\( r_n(t) \)是残差（反映信号的趋势）。计算每个IMF的能量占比：\[ E_j = \int_0^4 c_j(t)^2 dt, \quad E_{\text{total}} = \sum_{j=1}^4 E_j, \quad F_wj = \frac{E_j}{E_{\text{total}}} \]**作用**：EMD有效提取振动信号中的非平稳特征（如轴承故障的冲击信号），IMF的能量占比反映不同频率 band 的故障信息。

##### 5. 特征矩阵与选择
- **特征矩阵**：每个样本的13维特征包括5个时域特征、4个频域特征（BPFO幅值、BPFI幅值、BSF幅值、谐波总能量）、4个时频特征（EMD的4个IMF能量占比）。
- **特征选择**：采用ReliefF算法筛选有效特征，特征权重更新公式：\[ W(f) = W(f) - \frac{|x_h(f) - x_i(f)|}{m} + \frac{|x_m(f) - x_i(f)|}{m} \]其中，\( W(f) \)是特征\( f \)的权重，\( x_h \)是同类近邻样本，\( x_m \)是异类近邻样本，\( m \)是样本数。**作用**：保留对故障分类贡献大的特征。

### 问题二的核心需求与实现关键
#### 问题二的核心需求
基于问题一的13维特征矩阵，划分源域训练集与测试集；设计**CNN（卷积神经网络）**模型实现源域故障诊断，并通过准确率、混淆矩阵等指标评价模型性能。

#### 问题二的实现关键
需严格匹配输入的约束条件，并融合CNN的核心公式：

##### 1. 数据划分约束
- 训练集占比70%（\( N_{\text{train}}=113 \)），测试集占比30%（\( N_{\text{test}}=48 \)）；
- 分层抽样：对每个故障类型\( k \)（0=正常，1=内圈，2=外圈，3=滚动体），\( N_{\text{train},k} = \text{round}(N_k \times 0.7) \)，\( N_{\text{test},k} = N_k - N_{\text{train},k} \)（\( N_k \)是源域中类型\( k \)的样本数）；
- 随机种子\( \text{random_state}=42 \)。**作用**：保证训练集与测试集的故障类型分布一致，避免类别不平衡。

##### 2. 特征归一化约束
使用`StandardScaler`将特征标准化为均值0、方差1：\[ x_{\text{scaled}} = \frac{x - \mu_f}{\sigma_f} \]其中，\( \mu_f = \frac{1}{161}\sum_{i=1}^{161} x_{i,f} \)（特征\( f \)的源域均值），\( \sigma_f = \sqrt{\frac{1}{161}\sum_{i=1}^{161} (x_{i,f} - \mu_f)^2} \)（特征\( f \)的源域标准差）。**作用**：消除特征量纲差异，加速CNN模型收敛。

##### 3. CNN模型结构（核心公式框架）
CNN用于提取特征的局部相关性（适合轴承特征的多域融合），结构如下：
- **输入层**：将13维特征扩展为1D序列（形状为\( (13, 1) \)），适应CNN的1D卷积操作；
- **卷积层（1D）**：提取局部特征，输出特征图：\[ C_l = \sigma\left( W_l * X_{l-1} + b_l \right) \]其中，\( W_l \)是卷积核权重（形状为\( (k, 1) \)，\( k \)是卷积核大小），\( * \)是1D卷积操作，\( X_{l-1} \)是输入特征图，\( b_l \)是偏置，\( \sigma \)是ReLU激活函数（\( \sigma(x) = \max(0, x) \)）；
- **池化层（1D最大池化）**：降低特征维度，保留关键信息：\[ P_l = \max_{\tau \in \text{window}} C_l(\tau) \]其中，\( \text{window} \)是池化窗口；
- **全连接层**：将池化后的特征映射到4类故障空间：\[ FC = \sigma\left( W_{\text{fc}} \cdot P_{\text{flat}} + b_{\text{fc}} \right) \]其中，\( P_{\text{flat}} \)是池化层输出的扁平化向量（形状为\( (M, 1) \)，\( M \)是特征数）；
- **输出层**：Softmax激活得到4类概率：\[ y_{\text{pred}} = \text{Softmax}\left( W_{\text{out}} \cdot FC + b_{\text{out}} \right) \]其中，\( \text{Softmax}(z_k) = \frac{e^{z_k}}{\sum_{j=1}^4 e^{z_j}} \)（\( z_k \)是第\( k \)类的 logit 值）。

##### 4. 模型评价约束
- 准确率：\( \text{Accuracy} = \frac{TP + TN}{TP + TN + FP + FN} \)（\( TP \)真阳性，\( TN \)真阴性，\( FP \)假阳性，\( FN \)假阴性）；
- 精确率（分类型）：\( \text{Precision}*k = \frac{TP_k}{\sum*{j=0}^3 (TP_j + FP_j)} \)（\( TP_k \)是类型\( k \)的真阳性数）；
- 召回率（分类型）：\( \text{Recall}_k = \frac{TP_k}{TP_k + FN_k} \)（\( FN_k \)是类型\( k \)的假阴性数）；
- F1-score（分类型）：\( \text{F1}_k = 2 \cdot \frac{\text{Precision}_k \cdot \text{Recall}_k}{\text{Precision}_k + \text{Recall}_k} \)；
- 混淆矩阵：\( \text{CM}_{k,j} \)表示真实类型\( k \)预测为类型\( j \)的样本数。

### 问题三的核心需求与实现关键
#### 问题三的核心需求
基于问题二的CNN模型，结合**TCA（传输成分分析）**和**对抗域网络（DANN）**，学习源域与目标域的共性特征；构建目标域诊断模型，对16个未知标签的目标域数据分类，并可视化分析结果。

#### 问题三的实现关键
需严格匹配输入的约束条件，并融合TCA与DANN的核心公式：

##### 1. 源域与目标域共性约束
- 轴承类型一致：\( t_j^{\text{bt}} \in \{\text{SKF6205}, \text{SKF6203}\} \)；
- 特征维度一致：目标域特征矩阵\( X_t \)（16×13）与源域\( X_s \)（161×13）维度相同。

##### 2. 特征归一化约束
目标域特征使用源域的均值和标准差标准化：\[ x_{t,\text{scaled}} = \frac{x_t - \mu_f}{\sigma_f} \]其中，\( \mu_f \)和\( \sigma_f \)是问题二中源域特征的均值和标准差。

##### 3. TCA域对齐（核心公式）
TCA将源域与目标域特征映射到**再生核希尔伯特空间（RKHS）**，最小化域分布差异（MMD）并保留类别判别性：
- **核映射**：采用RBF核将特征映射到高维空间：\[ \Phi(x) = \exp\left( -\gamma \|x - x'\|^2 \right) \]其中，\( \gamma \)是核宽度，\( \|x - x'\|^2 \)是欧氏距离；
- **优化目标**：\[ \min_{\phi} \text{tr}(\phi^T L \phi) + \lambda \text{tr}(\phi^T M \phi) \]其中，\( \phi \)是投影矩阵，\( L \)是类别拉普拉斯矩阵（保留源域的类别判别性），\( M \)是域差异矩阵（最小化源域与目标域的MMD），\( \lambda \)是权衡参数。**作用**：学习域不变的特征表示，减少源域与目标域的分布差异。

##### 4. DANN模型结构与损失（核心公式）
DANN通过**梯度反转层（GRL）**实现特征提取器的域对抗训练，结构包括特征提取器\( G \)、标签分类器\( C \)、域分类器\( D \)：
- **特征提取器**：输入13维特征，输出64维域不变特征：\[ G(x) = \text{ReLU}\left( W_2 \cdot \text{ReLU}\left( W_1 \cdot x + b_1 \right) + b_2 \right) \]其中，\( W_1 \in \mathbb{R}^{64 \times 13} \)、\( W_2 \in \mathbb{R}^{64 \times 64} \)是权重矩阵，\( b_1 \in \mathbb{R}^{64} \)、\( b_2 \in \mathbb{R}^{64} \)是偏置。
- **标签分类器**：输入\( G(x) \)，输出4类概率：\[ C(G(x)) = \text{Softmax}\left( W_c \cdot G(x) + b_c \right) \]其中，\( W_c \in \mathbb{R}^{4 \times 64} \)是权重，\( b_c \in \mathbb{R}^4 \)是偏置。
- **域分类器**：输入\( G(x) \)，输出域标签（源域/目标域）概率：\[ D(G(x)) = \text{Sigmoid}\left( W_{d2} \cdot \text{ReLU}\left( W_{d1} \cdot G(x) + b_{d1} \right) + b_{d2} \right) \]其中，\( W_{d1} \in \mathbb{R}^{32 \times 64} \)、\( W_{d2} \in \mathbb{R}^{1 \times 32} \)是权重，\( b_{d1} \in \mathbb{R}^{32} \)、\( b_{d2} \in \mathbb{R}^1 \)是偏置。

##### 5. 损失函数与梯度反转
- **标签分类损失（源域）**：\[ L_{\text{cls}} = -\frac{1}{161}\sum_{i=1}^{161} \sum_{k=0}^3 y_{s,i,k} \log C(G(x_{s,i}))*k \]其中，\( y*{s,i,k} \)是源域样本\( i \)的独热编码标签（\( k \)类为1，其余为0）。
- **域分类损失**：\[ L_{\text{dom}} = -\frac{1}{161 + 16} \left( \sum_{i=1}^{161} \log D(G(x_{s,i})) + \sum_{j=1}^{16} \log(1 - D(G(x_{t,j}))) \right) \]其中，\( D(G(x)) \)是样本\( x \)属于源域的概率。
- **总损失**：\[ L_{\text{total}} = L_{\text{cls}} + \lambda L_{\text{dom}} \]其中，\( \lambda = \frac{\text{epochs}_{\text{current}}}{\text{epochs}} \)（随迭代线性递增，\( \text{epochs}=100 \)）。
- **梯度反转**：特征提取器的梯度包含分类损失的梯度和域损失的梯度反转：\[
  abla_G L_{\text{total}} =
  abla_G L_{\text{cls}} - \lambda
  abla_G L_{\text{dom}} \]**作用**：特征提取器\( G \)在最小化分类损失的同时，最大化域损失（通过反转梯度方向），从而学习到既判别又域不变的特征。

##### 6. 目标域分类
对目标域样本\( x_{t,j} \)，提取特征\( G(x_{t,j}) \)，标签分类器输出概率，取最大概率对应的类别：\[ y_{t,j} = \arg\max_k C(G(x_{t,j}))_k \]

### 问题四的核心需求与实现关键
#### 问题四的核心需求
分析迁移诊断模型的可解释性，包括**事前（模型结构合理性）、迁移过程（域对抗的作用）、事后（特征重要性）**，结合轴承故障机理说明模型的透明性，提高诊断人员的信任度。

#### 问题四的实现关键
需结合轴承故障机理与模型结构，解释可解释性的三个维度：

##### 1. 事前可解释性（模型结构合理性）
模型结构设计符合轴承故障的多域特征需求：
- **特征提取器\( G \)**：全连接层融合时域（如峰值）、频域（如BPFI幅值）、时频域（如EMD的IMF能量）特征，符合轴承故障特征的多域融合特性（比如内圈故障同时具有时域冲击和频域BPFI幅值升高）；
- **标签分类器\( C \)**：Softmax输出对应4类故障，直接映射到轴承的4种状态（正常、内圈、外圈、滚动体）；
- **域分类器\( D \)**：区分源域与目标域，促使\( G \)学习域不变特征，符合迁移学习的域对齐目标。

##### 2. 迁移过程可解释性（域对抗的作用）
域对抗训练通过**域损失的下降**和**梯度反转**实现特征对齐：
- **域损失\( L_{\text{dom}} \)的下降**：随着迭代次数增加，\( L_{\text{dom}} \)逐渐减小，说明源域与目标域的特征分布差异减小（\( D \)无法区分源域与目标域样本）；
- **梯度反转的作用**：特征提取器\( G \)的梯度包含\( -\lambda
  abla_G L_{\text{dom}} \)，即\( G \)在最小化分类损失的同时，最大化域损失（通过反转梯度方向），从而学习到**既判别又域不变**的特征（比如内圈故障的BPFI幅值特征，在源域与目标域中均能有效区分）。

##### 3. 事后可解释性（特征重要性）
采用**SHAP（SHapley Additive exPlanations）**计算特征对目标域样本预测的贡献，结合轴承机理解释关键特征：
- **SHAP值公式**：\[ \phi_f = \mathbb{E}*{X*{-f}}[f(X)] - \mathbb{E}*X[f(X)] \]其中，\( \phi_f \)是特征\( f \)的SHAP值（正表示该特征增加预测为某类的概率，负表示降低），\( X*{-f} \)是去除特征\( f \)的样本，\( \mathbb{E} \)是期望。
- **结合轴承机理的解释**：
  - 内圈故障样本：\( \text{Amp_BPFI} \)（内圈特征频率的幅值）的SHAP值最大，因为内圈故障时滚动体撞击内圈的频率对应BPFI，其幅值会显著升高；
  - 正常样本：\( \text{Kurtosis} \)（时域峭度）的SHAP值最小，因为正常信号无冲击，峭度接近0（高斯分布的峭度为3，减去3后接近0）；
  - 外圈故障样本：\( \text{Amp_BPFO} \)（外圈特征频率的幅值）的SHAP值最大，符合外圈故障的特征频率特性。

##### 4. 可解释性可视化
- **域对抗损失曲线**：展示\( L_{\text{dom}} \)随迭代的下降趋势，说明域差异的减小；
- **SHAP Summary Plot**：展示目标域样本各特征的SHAP值分布，突出关键特征（如\( \text{Amp_BPFI} \)的SHAP值集中在正值区域，说明对於内圈故障的预测贡献最大）；
- **神经元激活图**：展示特征提取器\( G \)的神经元对故障特征的响应（比如某神经元对\( \text{Amp_BPFI} > 0.5 \)的样本激活程度高，说明该神经元学习到内圈故障的特征）。

以上实现关键严格匹配输入的约束条件，并通过数学公式框架支撑问题的目标，确保可解释性分析的物理意义与模型逻辑一致。
